<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>校园运动器材管理系统</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', sans-serif;
    }
    body {
      background-color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      padding: 20px;
    }
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      width: 100%;
    }
    button:hover {
      background-color: #0069d9;
    }
    .hidden {
      display: none;
    }
    .menu {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .menu button {
      width: auto;
    }
    .tab-panel {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .login-tab {
      padding: 10px 20px;
      border: none;
      background-color: #f1f1f1;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      margin: 0 5px;
      font-weight: bold;
      flex: 1;
      max-width: 150px;
    }
    .login-tab.active {
      background-color: #007bff;
      color: white;
    }
    .login-panel {
      padding: 20px;
      border-radius: 5px;
      background-color: #ffffff;
    }
    .device-info {
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }
    .device-info p {
      margin-bottom: 8px;
      font-size: 16px;
    }
    .result {
      font-size: 18px;
      margin: 10px 0;
      font-weight: bold;
    }
    .door-control {
      display: flex;
      margin-top: 20px;
    }
    .door-open {
      background-color: #28a745;
    }
    .door-closed {
      background-color: #dc3545;
    }
    
    /* 响应式设计，适应安卓屏幕 */
    @media screen and (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .card {
        padding: 15px;
      }
      .menu {
        flex-direction: column;
        gap: 10px;
      }
      table, th, td {
        padding: 8px;
        font-size: 14px;
      }
      h1 {
        font-size: 20px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 16px;
      }
      button {
        padding: 10px 15px;
        font-size: 14px;
      }

      /* 异常处理表格在中等屏幕的优化 */
      #teacher-exception table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
    
    /* 针对更小屏幕的手机 */
    @media screen and (max-width: 480px) {
      .card {
        padding: 10px;
      }
      table, th, td {
        padding: 6px;
        font-size: 12px;
      }
      .menu button {
        font-size: 12px;
        padding: 8px 12px;
      }
      h1 {
        font-size: 18px;
      }
      h2 {
        font-size: 16px;
      }
      h3 {
        font-size: 14px;
      }

      /* 异常处理表格在小屏幕的优化 */
      #teacher-exception th,
      #teacher-exception td {
        padding: 4px;
        font-size: 11px;
      }
    }
    
    /* 异常处理表格样式 */
    #teacher-exception table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    #teacher-exception table tr:hover {
      background-color: #f1f7ff;
    }
    
    #teacher-exception table th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* 搜索框样式 */
    .search-container {
      margin: 15px 0;
      display: flex;
      justify-content: flex-end;
    }
    
    .search-input {
      width: 100%;
      max-width: 300px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    
    @media screen and (max-width: 480px) {
      .search-input {
        max-width: 100%;
        font-size: 12px;
      }
    }

    /* 状态单元格样式 */
    .status-cell {
      cursor: pointer;
      font-weight: bold;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .status-cell[data-status="pending"] {
      color: #dc3545;
      background-color: rgba(220, 53, 69, 0.1);
    }

    .status-cell[data-status="done"] {
      color: #28a745;
      background-color: rgba(40, 167, 69, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 登录界面 -->
    <div id="login-section" class="card">
      <h1>校园运动器材管理系统</h1>
      <div class="login-tabs">
        <button id="student-tab" class="login-tab active">学生登录</button>
        <button id="teacher-tab" class="login-tab">教师登录</button>
      </div>
      
      <div id="student-login" class="login-panel">
        <div class="form-group">
          <label for="student-username">账号</label>
          <input type="text" id="student-username" value="210797">
        </div>
        <div class="form-group">
          <label for="student-password">密码</label>
          <input type="password" id="student-password" value="210797">
        </div>
        <button id="student-login-btn">登录</button>
      </div>
      
      <div id="teacher-login" class="login-panel hidden">
        <div class="form-group">
          <label for="teacher-username">账号</label>
          <input type="text" id="teacher-username" value="359921">
        </div>
        <div class="form-group">
          <label for="teacher-password">密码</label>
          <input type="password" id="teacher-password" value="359921">
        </div>
        <button id="teacher-login-btn">登录</button>
      </div>
    </div>

    <!-- 学生功能界面 -->
    <div id="student-dashboard" class="card hidden">
      <h1>学生功能界面</h1>
      <div class="menu">
        <button class="menu-btn" data-target="student-history">历史记录</button>
        <button class="menu-btn" data-target="student-qrcode">查看二维码</button>
        <button id="student-logout">退出登录</button>
      </div>

      <!-- 历史记录界面 -->
      <div id="student-history" class="tab-panel">
        <h2>历史使用记录</h2>
        <div>一月总使用时长: <span id="total-year-hours">21</span> 小时</div>
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>器材</th>
              <th>使用时长 (小时)</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td>2025-03-30</td><td>乒乓球</td><td>2.5</td></tr>
            <tr><td>2025-03-27</td><td>跳绳</td><td>1.5</td></tr>
            <tr><td>2025-03-25</td><td>乒乓球</td><td>2</td></tr>
            <tr><td>2025-03-21</td><td>跳绳</td><td>1.5</td></tr>
            <tr><td>2025-03-18</td><td>乒乓球</td><td>3</td></tr>
            <tr><td>2025-03-15</td><td>跳绳</td><td>2</td></tr>
            <tr><td>2025-03-12</td><td>乒乓球</td><td>2.5</td></tr>
            <tr><td>2025-03-09</td><td>跳绳</td><td>1</td></tr>
            <tr><td>2025-03-05</td><td>乒乓球</td><td>3</td></tr>
            <tr><td>2025-03-01</td><td>跳绳</td><td>2</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 二维码界面 -->
      <div id="student-qrcode" class="tab-panel">
        <h2>学生二维码</h2>
        <div style="text-align: center; margin: 20px 0;">
          <p style="margin-bottom: 15px; font-size: 18px;">个人识别二维码</p>
          <div>
            <img id="qrcode-image" alt="学生二维码" style="border: 1px solid #ddd; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          </div>
          <p style="margin-top: 15px; color: #666; font-size: 14px;">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>

    <!-- 教师功能界面 -->
    <div id="teacher-dashboard" class="card hidden">
      <h1>教师功能界面</h1>
      <div class="menu">
        <button class="menu-btn" data-target="teacher-door">开关门柜</button>
        <button class="menu-btn" data-target="teacher-exception">异常处理</button>
        <button id="teacher-logout">退出登录</button>
      </div>

      <!-- 开关门柜界面 -->
      <div id="teacher-door" class="tab-panel">
        <h2>开关门柜管理</h2>
        <div class="form-group door-control">
          <button id="door-toggle" style="width: 120px;">加载中...</button>
        </div>
        
        <div class="device-info">
          <h3>设备状态</h3>
          <p class="result" id="lock-status">门状态: 查询中...</p>
          <p class="result" id="last-update-time">最后更新时间: 查询中...</p>
        </div>
      </div>

      <!-- 异常处理界面 -->
      <div id="teacher-exception" class="tab-panel">
        <h2>归还超时记录</h2>
        <div class="search-container">
          <input type="text" id="exception-search" placeholder="搜索..." class="search-input">
        </div>
        <table>
          <thead>
            <tr>
              <th>账号</th>
              <th>姓名</th>
              <th>时期</th>
              <th>柜子</th>
              <th>器材</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody id="exception-table-body">
            <tr>
              <td>210890</td><td>王一</td><td id="current-month-date-1"></td><td>1</td><td>乒乓球</td><td class="status-cell" data-status="pending">未处理</td>
            </tr>
            <tr>
              <td>210667</td><td>王五</td><td id="current-month-date-2"></td><td>2</td><td>跳绳</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>210333</td><td>吴九</td><td id="current-month-date-3"></td><td>3</td><td>乒乓球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>210456</td><td>周八</td><td id="current-month-date-4"></td><td>1</td><td>跳绳</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 设备状态变量
      let deviceVariables = {
        use_flag: false,  // 使用标志
        ping_pong: false, // 器材类型（false表示跳绳，true表示乒乓球）
        use_time: 0,      // 使用时长
        error_flag: 0, // 异常处理标志，整数类型，0表示无异常，非0表示账号
        cabinet: 0        // 柜子编号
      };
      
      // OneNet物联网平台API配置
      const config = {
        productId: '56i5KnK1KX',
        deviceName: 'ch32',
        authorization: 'version=2018-10-31&res=products%2F56i5KnK1KX%2Fdevices%2Fch32&et=1767233340&method=md5&sign=xTIiV6aZQvvpq1yJti58tQ%3D%3D',
        queryApiUrl: 'https://iot-api.heclouds.com/thingmodel/query-device-property',
        setApiUrl: 'https://iot-api.heclouds.com/thingmodel/set-device-desired-property'
      };
      
      // 更新异常处理界面的借走日期为当月日期
      function updateExceptionDates() {
        // 获取当前年月日
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth() + 1; // 月份从0开始，需要+1
        const currentDay = today.getDate(); // 今天的日期
        
        // 为每个日期单元格设置当月的日期，且不超过今天
        const date1 = document.getElementById('current-month-date-1');
        const date2 = document.getElementById('current-month-date-2');
        const date3 = document.getElementById('current-month-date-3');
        const date4 = document.getElementById('current-month-date-4');
        
        // 确保日期递减（倒序排列，最近的日期在最上面）
        // 最近的日期，不超过今天
        const day1 = currentDay;
        
        // 今天减少几天
        const day2 = Math.max(1, currentDay - 3); 
        
        // 更早的日期
        const day3 = Math.max(1, currentDay - 7); 
        
        // 最早的日期
        const day4 = Math.max(1, currentDay - 12); 
        
        if (date1) date1.textContent = formatDate(currentYear, currentMonth, day1);
        if (date2) date2.textContent = formatDate(currentYear, currentMonth, day2);
        if (date3) date3.textContent = formatDate(currentYear, currentMonth, day3);
        if (date4) date4.textContent = formatDate(currentYear, currentMonth, day4);
        
        // 更新状态：当日之前的记录状态改为"已处理"
        updatePastRecordsStatus();
        
        console.log(`已更新异常处理界面的时期（倒序）：${day1}, ${day2}, ${day3}, ${day4}`);
      }
      
      // 更新过去记录的状态
      function updatePastRecordsStatus() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0); // 设置为今天的开始时间
        
        const rows = exceptionTableBody.querySelectorAll('tr');
        rows.forEach(row => {
          const dateCell = row.cells[2]; // 时期单元格
          const statusCell = row.cells[5]; // 状态单元格
          
          if (dateCell && statusCell) {
            const dateStr = dateCell.textContent;
            const recordDate = new Date(dateStr);
            recordDate.setHours(0, 0, 0, 0);
            
            // 如果是过去的日期（早于今天），将状态设置为"已处理"
            if (recordDate < today) {
              statusCell.textContent = "已处理";
              statusCell.setAttribute('data-status', 'done');
            }
          }
        });
      }
      
      // 辅助函数：将各种值转换为布尔值
      function convertToBoolean(value) {
        if (typeof value === 'boolean') return value;
        if (value === 'true' || value === '1' || value === 1) return true;
        if (value === 'false' || value === '0' || value === 0) return false;
        return Boolean(value);
      }
      
      // 获取当前日期字符串（年-月-日格式）
      function getCurrentDateString() {
        const today = new Date();
        return today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
      }
      
      // 格式化日期为YYYY-MM-DD格式
      function formatDate(year, month, day) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
      
      // 初始化调用
      // 在DOM加载完成时更新异常处理界面日期
      updateExceptionDates();
      
      // 当切换到异常处理界面时更新日期
      document.querySelectorAll('.menu-btn').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          if (targetId === 'teacher-exception') {
            // 更新日期和设备状态
            setTimeout(() => {
              updateExceptionDates();
              fetchDeviceVariables();
            }, 100);
          }
        });
      });
      
      // 设置定时器，每秒更新一次设备变量
      const deviceStatusInterval = setInterval(fetchDeviceVariables, 1000);
      
      // 初始查询一次
      fetchDeviceVariables().then(() => {
        console.log('初始设备状态查询完成');
      }).catch(err => {
        console.error('初始设备状态查询失败:', err);
      });
      
      // 从OneNet API获取设备变量
      async function fetchDeviceVariables() {
        try {
          const apiUrl = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            // 获取设备属性列表
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            // 查找各种设备属性
            const useFlagProperty = properties.find(prop => prop.identifier === 'use_flag');
            const pingPongProperty = properties.find(prop => prop.identifier === 'ping_pong');
            const useTimeProperty = properties.find(prop => prop.identifier === 'use_time');
            const errorFlagProperty = properties.find(prop => prop.identifier === 'error_flag');
            const cabinetProperty = properties.find(prop => prop.identifier === 'cabinet');
            
            // 保存旧值用于比较
            const oldUseFlag = deviceVariables.use_flag;
            const oldErrorFlag = deviceVariables.error_flag;
            
            // 更新设备变量
            if (useFlagProperty) {
              deviceVariables.use_flag = convertToBoolean(useFlagProperty.value);
            }
            
            if (pingPongProperty) {
              deviceVariables.ping_pong = convertToBoolean(pingPongProperty.value);
            }
            
            if (useTimeProperty) {
              deviceVariables.use_time = parseFloat(useTimeProperty.value) || 0;
            }
            
            if (errorFlagProperty) {
              deviceVariables.error_flag = parseInt(errorFlagProperty.value) || 0;
            }
            
            if (cabinetProperty) {
              deviceVariables.cabinet = parseInt(cabinetProperty.value) || 0;
            }
            
            // 当error_flag发生任何变化时，在归还超时记录界面插入新记录
            if (oldErrorFlag !== deviceVariables.error_flag && deviceVariables.error_flag !== 0) {
              insertExceptionRecord();
            }
            
            const currentDateStr = getCurrentDateString();
            
            // 处理历史记录界面
            const historyTableBody = document.getElementById('history-table-body');
            
            if (historyTableBody) {
              const existingRow = findTodayRow(historyTableBody, currentDateStr);
              
              if (oldUseFlag === false && deviceVariables.use_flag === true) {
                if (existingRow) {
                  updateHistoryRow(existingRow);
                } else {
                  insertNewHistoryRecord(currentDateStr);
                }
              } else if (deviceVariables.use_flag === true && existingRow) {
                updateHistoryRow(existingRow);
              }
            }
            
            return true;
          } else {
            console.error('设备状态查询失败:', data.msg || '未知错误');
            return false;
          }
        } catch (error) {
          console.error('获取设备状态失败:', error);
          return false;
        }
      }
      
      // 查找当天的记录行
      function findTodayRow(tableBody, dateStr) {
        // 查找是否已存在当天日期的行
        for (let i = 0; i < tableBody.rows.length; i++) {
          const row = tableBody.rows[i];
          const dateCell = row.cells[0];
          if (dateCell && dateCell.textContent === dateStr) {
            return row;
          }
        }
        return null;
      }
      
      // 更新历史记录行
      function updateHistoryRow(row) {
        if (!row) return;
        
        // 更新器材类型 - ping_pong为true代表乒乓球，false代表跳绳
        const equipmentCell = row.cells[1];
        const equipment = deviceVariables.ping_pong ? '乒乓球' : '跳绳';
        if (equipmentCell.textContent !== equipment) {
          equipmentCell.textContent = equipment;
        }
        
        // 更新使用时长
        const durationCell = row.cells[2];
        if (parseFloat(durationCell.textContent) !== deviceVariables.use_time) {
          durationCell.textContent = deviceVariables.use_time;
          
          // 更新总使用时长
          updateTotalHours();
        }
      }
      
      // 插入新的历史记录
      function insertNewHistoryRecord(dateStr) {
        const historyTableBody = document.getElementById('history-table-body');
        
        if (!historyTableBody) {
          console.error('找不到历史记录表格体');
          return null;
        }
        
        // 如果没有提供日期，使用当前日期
        if (!dateStr) {
          dateStr = getCurrentDateString();
        }
        
        // 再次检查是否已存在该日期的记录，避免重复
        const existingRow = findTodayRow(historyTableBody, dateStr);
        if (existingRow) {
          // 已存在，只更新内容
          updateHistoryRow(existingRow);
          return existingRow;
        }
        
        // 确定器材类型 - ping_pong为true代表乒乓球，false代表跳绳
        const equipment = deviceVariables.ping_pong ? '乒乓球' : '跳绳';
        
        // 创建新行
        const newRow = document.createElement('tr');
        
        // 设置行内容
        newRow.innerHTML = `<td>${dateStr}</td><td>${equipment}</td><td>${deviceVariables.use_time}</td>`;
        
        // 插入到表格顶部
        if (historyTableBody.firstChild) {
          historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
        } else {
          historyTableBody.appendChild(newRow);
        }
        
        // 更新总使用时长
        updateTotalHours();
        
        return newRow;
      }
      
      // 更新总使用时长
      function updateTotalHours() {
        const totalHoursElement = document.getElementById('total-year-hours');
        if (!totalHoursElement) return;
        
        // 获取表格中所有的使用时长
        const hours = Array.from(document.querySelectorAll('#student-history tbody td:nth-child(3)'))
          .map(td => parseFloat(td.textContent) || 0);
        
        // 计算总和
        const totalHours = hours.reduce((sum, hour) => sum + hour, 0);
        
        // 更新显示
        totalHoursElement.textContent = totalHours.toFixed(1);
      }
      
      // 登录标签页切换
      document.getElementById('student-tab').addEventListener('click', () => toggleLoginPanels('student'));
      document.getElementById('teacher-tab').addEventListener('click', () => toggleLoginPanels('teacher'));
      
      function toggleLoginPanels(userType) {
        const isStudent = userType === 'student';
        document.getElementById('student-login').classList.toggle('hidden', !isStudent);
        document.getElementById('teacher-login').classList.toggle('hidden', isStudent);
        document.getElementById('student-tab').classList.toggle('active', isStudent);
        document.getElementById('teacher-tab').classList.toggle('active', !isStudent);
      }
      
      // 登录功能
      document.getElementById('student-login-btn').addEventListener('click', () => login('student'));
      document.getElementById('teacher-login-btn').addEventListener('click', () => login('teacher'));
      
      function login(userType) {
        const username = document.getElementById(userType + '-username').value;
        const password = document.getElementById(userType + '-password').value;
        
        const credentials = {
          student: {username: '210797', password: '210797'},
          teacher: {username: '359921', password: '359921'},
          '175905': {type: 'student', password: '175905'},
          '175908': {type: 'student', password: '175908'}
        };
        
        // 验证登录
        let loginSuccess = false;
        let dashboardType = '';
        
        // 标准学生账号登录
        if (userType === 'student' && username === credentials.student.username && 
            password === credentials.student.password) {
          loginSuccess = true;
          dashboardType = 'student';
        } 
        // 标准教师账号登录
        else if (userType === 'teacher' && username === credentials.teacher.username && 
            password === credentials.teacher.password) {
          loginSuccess = true;
          dashboardType = 'teacher';
        } 
        // 其他学生账号登录
        else if (credentials[username] && credentials[username].type === 'student' && 
            credentials[username].password === password) {
          loginSuccess = true;
          dashboardType = 'student';
        }
        
        if (loginSuccess) {
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById(dashboardType + '-dashboard').classList.remove('hidden');
          
          // 默认显示第一个功能界面
          const firstMenuBtn = document.querySelector('#' + dashboardType + '-dashboard .menu-btn');
          if (firstMenuBtn) firstMenuBtn.click();
        } else {
          alert(userType === 'student' ? '学生账号或密码错误!' : '教师账号或密码错误!');
        }
      }

      // 退出登录
      document.getElementById('student-logout').addEventListener('click', () => logout('student'));
      document.getElementById('teacher-logout').addEventListener('click', () => logout('teacher'));
      
      function logout(userType) {
        document.getElementById(userType + '-dashboard').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        
        // 重置登录表单
        if (userType === 'student') {
          document.getElementById('student-tab').click();
          document.getElementById('student-username').value = '';
          document.getElementById('student-password').value = '';
        } else {
          document.getElementById('teacher-tab').click();
          document.getElementById('teacher-username').value = '';
          document.getElementById('teacher-password').value = '';
        }
      }

      // 菜单切换功能
      document.querySelectorAll('.menu-btn').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const dashboard = this.closest('.card');
          
          dashboard.querySelectorAll('.tab-panel').forEach(panel => {
            panel.style.display = 'none';
          });
          
          if(targetId) {
            document.getElementById(targetId).style.display = 'block';
            
            if(targetId === 'teacher-door') {
              queryDeviceStatus();
            } else if(targetId === 'student-qrcode') {
              loadStudentQRCode();
            } else if(targetId === 'student-history') {
              // 加载历史记录时，确保历史记录面板可见
              console.log('切换到历史记录界面');
              document.getElementById('student-history').style.display = 'block';
              // 立即检查一次设备状态
              fetchDeviceVariables();
            }
          }
        });
      });

      // 设备状态变量
      let deviceStatus = {
        isLocked: true,
        lastUpdateTime: ''
      };
      
      // 查询设备状态
      async function queryDeviceStatus() {
        try {
          const url = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            deviceStatus.lastUpdateTime = new Date().toLocaleString();
            
            // 查找Lock属性
            const lockProperty = properties.find(prop => prop.identifier === 'Lock' || prop.identifier === 'lock');
            
            if (lockProperty) {
              const value = lockProperty.value;
              if (typeof value === 'boolean') deviceStatus.isLocked = value;
              else if (value === 'true' || value === 'false') deviceStatus.isLocked = (value === 'true');
              else if (value === '1' || value === '0') deviceStatus.isLocked = (value === '1');
              else if (value === 1 || value === 0) deviceStatus.isLocked = (value === 1);
              else deviceStatus.isLocked = Boolean(value);
              
              document.getElementById('lock-status').textContent = `门状态: ${deviceStatus.isLocked ? '已关门 (Lock = true)' : '已开门 (Lock = false)'}`;
            } else {
              document.getElementById('lock-status').textContent = '门状态: 未找到数据';
            }
            
            document.getElementById('last-update-time').textContent = `最后更新时间: ${deviceStatus.lastUpdateTime}`;
            updateDeviceStatusUI();
            return true;
          } else {
            throw new Error(data.error || data.msg || '查询失败');
          }
        } catch (error) {
          console.error('查询设备状态失败:', error);
          document.getElementById('lock-status').textContent = '门状态: 查询出错';
          return false;
        }
      }
      
      // 设置设备锁状态
      async function setDeviceLockStatus(isLocked) {
        try {
          const doorToggleBtn = document.getElementById('door-toggle');
          doorToggleBtn.disabled = true;
          
          const requestData = {
            product_id: config.productId,
            device_name: config.deviceName,
            params: { Lock: isLocked }
          };
          
          const response = await fetch(config.setApiUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': config.authorization
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.errno === 0 || data.code === 0) {
            deviceStatus.isLocked = isLocked;
            deviceStatus.lastUpdateTime = new Date().toLocaleString();
            
            document.getElementById('lock-status').textContent = `门状态: ${deviceStatus.isLocked ? '已关门 (Lock = true)' : '已开门 (Lock = false)'}`;
            document.getElementById('last-update-time').textContent = `最后更新时间: ${deviceStatus.lastUpdateTime}`;
            
            updateDeviceStatusUI();
            setTimeout(() => queryDeviceStatus(), 2000);
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '设置失败');
          }
        } catch (error) {
          console.error('设置门锁状态失败:', error);
          document.getElementById('lock-status').textContent = '门状态: 设置失败';
          return false;
        } finally {
          document.getElementById('door-toggle').disabled = false;
        }
      }
      
      // 更新设备状态界面
      function updateDeviceStatusUI() {
        const doorToggleBtn = document.getElementById('door-toggle');
        doorToggleBtn.textContent = deviceStatus.isLocked ? '已关门' : '已开门';
        doorToggleBtn.classList.remove('door-open', 'door-closed');
        doorToggleBtn.classList.add(deviceStatus.isLocked ? 'door-closed' : 'door-open');
      }
      
      // 开关门柜功能
      document.getElementById('door-toggle').addEventListener('click', async function() {
        this.disabled = true;
        await setDeviceLockStatus(!deviceStatus.isLocked);
      });
      
      // 加载学生二维码
      function loadStudentQRCode() {
        const studentUsername = document.getElementById('student-username').value || '210797';
        document.getElementById('qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${studentUsername}`;
      }

      // 插入归还超时记录
      function insertExceptionRecord() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        // 检查error_flag是否为非0，只有不为0时才插入记录
        if (deviceVariables.error_flag === 0) return;
        
        // 获取当前日期
        const dateStr = getCurrentDateString();
        
        // 确定柜子编号
        const cabinetNumber = deviceVariables.cabinet;
        
        // 确定器材类型
        const equipment = deviceVariables.ping_pong ? '乒乓球' : '跳绳';
        
        // 获取账号
        const account = deviceVariables.error_flag.toString();
        
        // 根据账号随机生成姓名
        const names = ['张三', '李四', '王五', '赵六', '钱七', '孙八', '周九', '郑十', '吴一', '陈二'];
        const name = getRandomName(account, names);
        
        // 检查当天是否已存在该账号的记录
        const rows = exceptionTableBody.querySelectorAll('tr');
        let accountExists = false;
        
        rows.forEach(row => {
          const accountCell = row.cells[0]; // 账号单元格
          const dateCell = row.cells[2]; // 时期单元格
          
          if (accountCell && dateCell && 
              accountCell.textContent === account && 
              dateCell.textContent === dateStr) {
            accountExists = true;
          }
        });
        
        // 如果当天已存在该账号的记录，则不添加
        if (accountExists) return;
        
        // 创建新行
        const newRow = document.createElement('tr');
        
        // 设置行内容
        newRow.innerHTML = `
          <td>${account}</td>
          <td>${name}</td>
          <td>${dateStr}</td>
          <td>${cabinetNumber}</td>
          <td>${equipment}</td>
          <td class="status-cell" data-status="pending">未处理</td>
        `;
        
        // 插入到表格顶部
        if (exceptionTableBody.firstChild) {
          exceptionTableBody.insertBefore(newRow, exceptionTableBody.firstChild);
        } else {
          exceptionTableBody.appendChild(newRow);
        }
        
        // 确保当日之前的记录状态为"已处理"
        updatePastRecordsStatus();
      }
      
      // 根据账号获取随机但固定的姓名
      function getRandomName(account, names) {
        // 使用账号作为种子生成固定的随机索引
        const seed = parseInt(account.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0));
        const index = seed % names.length;
        return names[index];
      }

      // 添加状态单元格的点击事件
      function setupStatusCellClickEvents() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        exceptionTableBody.addEventListener('click', function(event) {
          const target = event.target;
          if (target.classList.contains('status-cell')) {
            // 获取当前状态并切换
            const currentStatus = target.getAttribute('data-status');
            const newStatus = currentStatus === 'pending' ? 'done' : 'pending';
            
            // 更新UI
            target.setAttribute('data-status', newStatus);
            target.textContent = newStatus === 'pending' ? '未处理' : '已处理';
          }
        });
      }
      
      // 添加状态单元格的点击事件
      setupStatusCellClickEvents();
    });
  </script>
</body>
</html>