<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>校园运动器材管理系统</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', sans-serif;
    }
    body {
      background-color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      padding: 20px;
    }
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      width: 100%;
    }
    button:hover {
      background-color: #0069d9;
    }
    .hidden {
      display: none;
    }
    .menu {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .menu button {
      width: auto;
    }
    .tab-panel {
      display: none;
      transition: opacity 0.3s ease-in-out;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      transition: all 0.2s ease-in-out;
    }
    th {
      background-color: #f2f2f2;
    }
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .login-tab {
      padding: 10px 20px;
      border: none;
      background-color: #f1f1f1;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      margin: 0 5px;
      font-weight: bold;
      flex: 1;
      max-width: 150px;
    }
    .login-tab.active {
      background-color: #007bff;
      color: white;
    }
    .login-panel {
      padding: 20px;
      border-radius: 5px;
      background-color: #ffffff;
    }
    .device-info {
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }
    .device-info p {
      margin-bottom: 8px;
      font-size: 16px;
    }
    .result {
      font-size: 18px;
      margin: 10px 0;
      font-weight: bold;
    }
    .door-control {
      display: flex;
      margin-top: 20px;
    }
    .door-open {
      background-color: #28a745;
    }
    .door-closed {
      background-color: #dc3545;
    }
    
    /* 响应式设计，适应安卓屏幕 */
    @media screen and (max-width: 768px) {
      .container {
        padding: 10px;
        max-width: 100%;
      }
      .card {
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .menu {
        flex-direction: column;
        gap: 10px;
        padding: 10px !important;
      }
      table, th, td {
        padding: 8px;
        font-size: 14px;
      }
      h1 {
        font-size: 20px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 16px;
      }
      button {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      /* 移动端优化动画和变换效果 */
      .card {
        transform: none !important;
      }
      .card:hover {
        transform: none !important;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      
      /* 降低表格行的动画强度 */
      tbody tr:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 123, 255, 0.1);
      }
      
      /* 优化设备状态布局 */
      .device-info > div {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }
      
      /* 门柜控制按钮优化 */
      #teacher-door .form-group button {
        width: 120px !important;
        height: 45px !important;
        margin: 0 5px !important;
      }
      
      /* 登录板块优化 */
      #login-section h3 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      
      #login-section h1 {
        font-size: 22px;
      }
      
      /* 表格溢出处理 */
      .tab-panel table {
        width: 100%;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      /* 二维码适配 */
      #qrcode-image, #teacher-qrcode-image {
        max-width: 85%;
        height: auto;
      }
    }
    
    /* 针对更小屏幕的手机 */
    @media screen and (max-width: 480px) {
      .card {
        padding: 12px;
        margin: 5px 0;
        border-radius: 12px;
      }
      
      table, th, td {
        padding: 6px;
        font-size: 12px;
      }
      
      .menu-btn, button {
        font-size: 12px;
        padding: 8px 12px;
        margin: 3px 0;
        border-radius: 8px;
      }
      
      h1 {
        font-size: 18px;
      }
      
      h2 {
        font-size: 16px;
        padding: 8px !important;
      }
      
      h3 {
        font-size: 14px;
      }
      
      /* 简化按钮的动画效果 */
      .menu-btn:after, button:after {
        display: none;
      }
      
      /* 进一步简化卡片动画 */
      .card, .card:hover {
        transform: none !important;
        transition: none !important;
      }
      
      /* 优化表单元素 */
      input {
        padding: 8px;
        font-size: 14px;
      }
      
      /* 优化登录界面 */
      #login-section h3 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      #login-section h1 {
        font-size: 20px;
      }
      
      /* 优化门柜控制 */
      #teacher-door .form-group {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      #teacher-door .form-group button {
        width: 90px !important;
        height: 40px !important;
        font-size: 11px;
        margin: 5px !important;
      }
      
      /* 优化状态设备卡片 */
      .device-info {
        padding: 15px !important;
      }
      
      .device-info > div > div {
        padding: 10px !important;
      }
      
      /* 异常处理表格在小屏幕的优化 */
      #teacher-exception th,
      #teacher-exception td {
        padding: 4px;
        font-size: 11px;
      }
      
      /* 优化二维码显示 */
      #qrcode-image, #teacher-qrcode-image {
        max-width: 80%;
        height: auto;
      }
      
      /* 优化动画效果 */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translate3d(0, 10px, 0);
        }
        to {
          opacity: 1;
          transform: translate3d(0, 0, 0);
        }
      }
      
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); }
      }
    }
    
    /* 异常处理表格样式 */
    #teacher-exception table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    #teacher-exception table tr:hover {
      background-color: #f1f7ff;
    }
    
    #teacher-exception table th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* 搜索框样式 */
    .search-container {
      margin: 15px 0;
      display: flex;
      justify-content: flex-end;
    }
    
    .search-input {
      width: 100%;
      max-width: 300px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    
    @media screen and (max-width: 480px) {
      .search-input {
        max-width: 100%;
        font-size: 12px;
      }
    }

    /* 状态单元格样式 */
    .status-cell {
      cursor: pointer;
      font-weight: bold;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.25s ease-in-out;
    }

    .status-cell[data-status="pending"] {
      color: #dc3545;
      background-color: rgba(220, 53, 69, 0.1);
    }

    .status-cell[data-status="done"] {
      color: #28a745;
      background-color: rgba(40, 167, 69, 0.1);
    }

    /* 添加动画关键帧 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    @keyframes slideIn {
      from { 
        transform: translateY(-10px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* 新增动画效果 - 更加柔和 */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translate3d(0, 20px, 0);
      }
      to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
      }
    }
    
    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    
    /* 表格行悬停效果 */
    tbody tr {
      transition: all 0.3s ease;
    }
    
    tbody tr:hover {
      background-color: #f1f7ff !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);
    }
    
    /* 按钮悬停效果增强 */
    .menu-btn, button {
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    
    .menu-btn:after, button:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      transform: scaleX(0);
      transform-origin: right;
      transition: transform 0.4s ease;
      z-index: -1;
    }
    
    .menu-btn:hover:after, button:hover:after {
      transform: scaleX(1);
      transform-origin: left;
    }
    
    /* 添加卡片动画效果 */
    .card {
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }

    /* 更柔和的阴影和过渡 */
    .card {
      transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    /* 按钮过渡效果优化 */
    button, .menu-btn {
      transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 登录界面 -->
    <div id="login-section" class="card">
      <h3 style="color: #007bff; font-family: 'Microsoft YaHei', sans-serif; margin-bottom: 15px; font-weight: 600; text-align: center; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,123,255,0.2); font-size: 22px; background: linear-gradient(45deg, #007bff, #00a8ff); -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent; padding: 5px; animation: fadeIn 1.5s ease-in-out;">2025共创芯未来</h3>
      <h1 style="font-size: 28px; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: slideIn 1s ease-out;">校园运动器材管理系统</h1>
      <div class="login-tabs">
        <button id="student-tab" class="login-tab active">学生登录</button>
        <button id="teacher-tab" class="login-tab">教师登录</button>
      </div>
      
      <div id="student-login" class="login-panel">
        <div class="form-group">
          <label for="student-username">账号</label>
          <input type="text" id="student-username" value="210797">
        </div>
        <div class="form-group">
          <label for="student-password">密码</label>
          <input type="password" id="student-password" value="210797">
        </div>
        <button id="student-login-btn">登录</button>
      </div>
      
      <div id="teacher-login" class="login-panel hidden">
        <div class="form-group">
          <label for="teacher-username">账号</label>
          <input type="text" id="teacher-username" value="359921">
        </div>
        <div class="form-group">
          <label for="teacher-password">密码</label>
          <input type="password" id="teacher-password" value="359921">
        </div>
        <button id="teacher-login-btn">登录</button>
      </div>
    </div>

    <!-- 学生功能界面 -->
    <div id="student-dashboard" class="card hidden">
      <div style="text-align: center; margin-bottom: 25px;">
        <h3 style="color: #007bff; font-family: 'Microsoft YaHei', sans-serif; margin-bottom: 10px; font-weight: 600; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,123,255,0.2); font-size: 22px; background: linear-gradient(45deg, #007bff, #00a8ff); -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent; padding: 5px; animation: fadeIn 1.5s ease-in-out;">2025共创芯未来</h3>
        <h1 style="font-size: 28px; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: slideIn 1s ease-out;">校园运动器材管理系统</h1>
      </div>
      <h2 style="text-align: center; color: #333; margin-bottom: 25px; background-color: #f8f9fa; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">学生功能界面</h2>
      <div class="menu" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <button class="menu-btn" data-target="student-history" style="background: linear-gradient(to right, #007bff, #0069d9); transition: all 0.3s;">历史记录</button>
        <button class="menu-btn" data-target="student-qrcode" style="background: linear-gradient(to right, #007bff, #0069d9); transition: all 0.3s;">查看二维码</button>
        <button id="student-logout" style="background: linear-gradient(to right, #6c757d, #5a6268); transition: all 0.3s;">退出登录</button>
      </div>

      <!-- 历史记录界面 -->
      <div id="student-history" class="tab-panel">
        <h2 style="animation: fadeInUp 0.8s ease-out;">历史使用记录</h2>
        <div style="animation: fadeInUp 1s ease-out; background: linear-gradient(to right, #f8f9fa, #e9ecef); padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
          历史使用总时长: <span id="total-year-hours" style="font-weight: bold; font-size: 24px; color: #007bff;">21</span> 小时
        </div>
        
        <table style="animation: fadeInUp 1.2s ease-out; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 8px; overflow: hidden;">
          <thead style="background: linear-gradient(to right, #007bff, #0069d9); color: white;">
            <tr>
              <th style="padding: 15px; border-top-left-radius: 8px;">日期</th>
              <th style="padding: 15px;">器材</th>
              <th style="padding: 15px; border-top-right-radius: 8px;">使用时长 (小时)</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <!-- 历史记录将在JavaScript中动态生成 -->
          </tbody>
        </table>
      </div>

      <!-- 二维码界面 -->
      <div id="student-qrcode" class="tab-panel">
        <h2 style="animation: fadeInUp 0.8s ease-out;">学生二维码</h2>
        <div style="text-align: center; margin: 20px 0; animation: fadeInUp 1s ease-out;">
          <p style="margin-bottom: 15px; font-size: 18px; color: #333;">个人识别二维码</p>
          <div style="animation: pulse 2s infinite ease-in-out;">
            <img id="qrcode-image" alt="学生二维码" style="border: 1px solid #ddd; padding: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; transition: all 0.3s;">
          </div>
          <p style="margin-top: 15px; color: #666; font-size: 14px; background-color: #f8f9fa; display: inline-block; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>

    <!-- 教师功能界面 -->
    <div id="teacher-dashboard" class="card hidden">
      <div style="text-align: center; margin-bottom: 25px;">
        <h3 style="color: #007bff; font-family: 'Microsoft YaHei', sans-serif; margin-bottom: 10px; font-weight: 600; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,123,255,0.2); font-size: 22px; background: linear-gradient(45deg, #007bff, #00a8ff); -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent; padding: 5px; animation: fadeIn 1.5s ease-in-out;">2025共创芯未来</h3>
        <h1 style="font-size: 28px; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: slideIn 1s ease-out;">校园运动器材管理系统</h1>
      </div>
      <h2 style="text-align: center; color: #333; margin-bottom: 25px; background-color: #f8f9fa; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">教师功能界面</h2>
      <div class="menu" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
        <button class="menu-btn" data-target="teacher-door" style="background: linear-gradient(to right, #007bff, #0069d9); transition: all 0.3s;">开关门柜</button>
        <button class="menu-btn" data-target="teacher-exception" style="background: linear-gradient(to right, #007bff, #0069d9); transition: all 0.3s;">异常处理</button>
        <button class="menu-btn" data-target="teacher-qrcode" style="background: linear-gradient(to right, #007bff, #0069d9); transition: all 0.3s;">查看二维码</button>
        <button id="teacher-logout" style="background: linear-gradient(to right, #6c757d, #5a6268); transition: all 0.3s;">退出登录</button>
      </div>

      <!-- 开关门柜界面 -->
      <div id="teacher-door" class="tab-panel">
        <h2 style="animation: fadeInUp 0.8s ease-out;">开关门柜管理</h2>
        <div class="form-group door-control" style="animation: fadeInUp 1s ease-out; display: flex; justify-content: center; gap: 20px; margin-bottom: 30px;">
          <button id="door1-toggle" style="width: 150px; margin-right: 10px; height: 50px; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s;">加载中...</button>
          <button id="door2-toggle" style="width: 150px; margin-right: 10px; height: 50px; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s;">加载中...</button>
          <button id="door3-toggle" style="width: 150px; height: 50px; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s;">加载中...</button>
        </div>
        
        <div class="device-info" style="animation: fadeInUp 1.2s ease-out; background: linear-gradient(to right, #f8f9fa, #e9ecef); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
          <h3 style="text-align: center; margin-bottom: 25px; color: #007bff; font-size: 22px;">设备状态</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="padding: 15px; background-color: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              <p class="result" id="lock1-status" style="font-size: 18px; color: #333;">门1状态: 查询中...</p>
              <p class="result" id="lock1-update-time" style="font-size: 14px; color: #666;">最后更新时间: 查询中...</p>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              <p class="result" id="lock2-status" style="font-size: 18px; color: #333;">门2状态: 查询中...</p>
              <p class="result" id="lock2-update-time" style="font-size: 14px; color: #666;">最后更新时间: 查询中...</p>
            </div>
            <div style="padding: 15px; background-color: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              <p class="result" id="lock3-status" style="font-size: 18px; color: #333;">门3状态: 查询中...</p>
              <p class="result" id="lock3-update-time" style="font-size: 14px; color: #666;">最后更新时间: 查询中...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 异常处理界面 -->
      <div id="teacher-exception" class="tab-panel">
        <h2 style="animation: fadeInUp 0.8s ease-out;">归还超时记录</h2>
        <div class="search-container" style="animation: fadeInUp 1s ease-out; margin: 20px 0; background: linear-gradient(to right, #f8f9fa, #e9ecef); padding: 15px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
          <input type="text" id="exception-search" placeholder="搜索..." class="search-input" style="width: 100%; border-radius: 30px; padding: 12px 20px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s;" onfocus="this.style.boxShadow='0 2px 15px rgba(0,123,255,0.2)'" onblur="this.style.boxShadow='0 2px 10px rgba(0,0,0,0.05)'">
        </div>
        <table style="animation: fadeInUp 1.2s ease-out; width: 100%; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 12px; overflow: hidden; border-collapse: separate; border-spacing: 0;">
          <thead style="background: linear-gradient(to right, #007bff, #0069d9); color: white;">
            <tr>
              <th style="padding: 15px; border-top-left-radius: 12px;">账号</th>
              <th style="padding: 15px;">姓名</th>
              <th style="padding: 15px;">时期</th>
              <th style="padding: 15px;">柜子</th>
              <th style="padding: 15px;">器材</th>
              <th style="padding: 15px; border-top-right-radius: 12px;">状态</th>
            </tr>
          </thead>
          <tbody id="exception-table-body">
            <!-- 异常记录将在JavaScript中动态生成 -->
          </tbody>
        </table>
      </div>

      <!-- 教师二维码界面 -->
      <div id="teacher-qrcode" class="tab-panel">
        <h2 style="animation: fadeInUp 0.8s ease-out;">教师二维码</h2>
        <div style="text-align: center; margin: 20px 0; animation: fadeInUp 1s ease-out;">
          <p style="margin-bottom: 20px; font-size: 20px; color: #333; background: linear-gradient(45deg, #007bff, #00a8ff); -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent; display: inline-block; padding: 5px 15px;">教师识别二维码</p>
          <div style="animation: pulse 2s infinite ease-in-out;">
            <img id="teacher-qrcode-image" alt="教师二维码" style="border: 1px solid #ddd; padding: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 15px; transition: all 0.3s; background-color: white;">
          </div>
          <p style="margin-top: 20px; color: #666; font-size: 16px; background-color: #f8f9fa; display: inline-block; padding: 10px 20px; border-radius: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 设置默认账号密码
      document.getElementById('student-username').value = '210797';
      document.getElementById('student-password').value = '210797';
      document.getElementById('teacher-username').value = '359921';
      document.getElementById('teacher-password').value = '359921';
      
      // 设备状态变量
      let deviceVariables = {
        use_flag: false,
        equipment_type: 0,
        use_time: 0,
        错误标志: 0,
        cabinet: 0,
        Lock1: false,
        Lock2: false,
        Lock3: false
      };
      
      // 保存上一个状态的use_flag，用于检测变化
      let previousUseFlag = false;
      
      // 初始化历史记录
      generateInitialHistoryRecords();
      
      // 初始化异常记录
      generateInitialExceptionRecords();
      
      // 生成初始的历史记录数据
      function generateInitialHistoryRecords() {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return;
        
        // 清空现有记录
        historyTableBody.innerHTML = '';
        
        // 获取当前日期
        const today = new Date();
        
        // 器材类型选项
        const equipmentTypes = ['乒乓球', '跳绳', '篮球'];
        
        // 生成20条历史记录，均匀分布在过去两个月内
        for (let i = 0; i < 20; i++) {
          // 计算日期，均匀分布在过去两个月内
          const daysAgo = Math.floor((60 / 20) * (i + 1));
          const recordDate = new Date(today);
          recordDate.setDate(today.getDate() - daysAgo);
          
          // 格式化日期
          const dateStr = recordDate.getFullYear() + '-' + 
                         String(recordDate.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(recordDate.getDate()).padStart(2, '0');
          
          // 随机选择器材
          const equipment = equipmentTypes[Math.floor(Math.random() * equipmentTypes.length)];
          
          // 随机生成0.5到3小时的使用时长
          const usageTime = (Math.random() * 2.5 + 0.5).toFixed(1);
          
          // 创建表格行
          const row = document.createElement('tr');
          row.innerHTML = `<td>${dateStr}</td><td>${equipment}</td><td>${usageTime}</td>`;
          
          // 添加到表格
          historyTableBody.appendChild(row);
        }
        
        // 更新总使用时长
        updateTotalHours();
      }
      
      // 存储用户名和姓名的映射
      const userNameMap = {
        '175905': '李明',
        '210797': '张华',
        '175908': '王芳'
      };
      
      // OneNet物联网平台API配置
      const config = {
        productId: '56i5KnK1KX',
        deviceName: 'ch32',
        authorization: 'version=2018-10-31&res=products%2F56i5KnK1KX%2Fdevices%2Fch32&et=1767233340&method=md5&sign=xTIiV6aZQvvpq1yJti58tQ%3D%3D',
        queryApiUrl: 'https://iot-api.heclouds.com/thingmodel/query-device-property',
        setApiUrl: 'https://iot-api.heclouds.com/thingmodel/set-device-desired-property'
      };
      
      // 辅助函数
      function convertToBoolean(value) {
        if (typeof value === 'boolean') return value;
        if (value === 'true' || value === '1' || value === 1) return true;
        if (value === 'false' || value === '0' || value === 0) return false;
        return Boolean(value);
      }
      
      function getCurrentDateString() {
        const today = new Date();
        return today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
      }
      
      function formatDate(year, month, day) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
      
      // 生成最近两个月内的随机日期
      function generateRecentDate(daysAgo) {
        const today = new Date();
        const pastDate = new Date(today);
        pastDate.setDate(today.getDate() - daysAgo);
        
        const year = pastDate.getFullYear();
        const month = String(pastDate.getMonth() + 1).padStart(2, '0');
        const day = String(pastDate.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
      }
      
      // 更新表格中的日期为最近两个月内的日期
      const dateCells = document.querySelectorAll('#exception-table-body tr td:nth-child(3)');
      dateCells.forEach((cell, index) => {
        // 根据索引生成不同的日期，确保日期分布在最近两个月内
        const daysAgo = 5 + (index * 7); // 5, 12, 19, 26, 33, 40, 47, 54天前
        cell.textContent = generateRecentDate(daysAgo);
      });
      
      // 绑定状态单元格点击事件
      document.querySelectorAll('.status-cell').forEach(cell => {
        cell.addEventListener('click', function() {
          const currentStatus = this.getAttribute('data-status');
          const newStatus = currentStatus === 'done' ? 'pending' : 'done';
          
          // 更新状态文本和属性
          this.setAttribute('data-status', newStatus);
          this.textContent = newStatus === 'done' ? '已处理' : '未处理';
          
          // 确保颜色样式正确应用
          if (newStatus === 'pending') {
            this.style.color = '#dc3545';
            this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
          } else {
            this.style.color = '#28a745';
            this.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
          }
        });
      });
      
      // 界面切换事件
      document.querySelectorAll('.menu-btn').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const dashboard = this.closest('.card');
          
          // 高亮当前选中的按钮
          dashboard.querySelectorAll('.menu-btn').forEach(btn => {
            btn.style.opacity = '0.8';
            btn.style.transform = 'scale(1)';
          });
          this.style.opacity = '1';
          this.style.transform = 'scale(1.05)';
          
          // 添加过渡效果
          dashboard.querySelectorAll('.tab-panel').forEach(panel => {
            panel.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => {
              panel.style.display = 'none';
            }, 300);
          });
          
          if(targetId) {
            setTimeout(() => {
              const targetPanel = document.getElementById(targetId);
              targetPanel.style.display = 'block';
              targetPanel.style.animation = 'fadeIn 0.5s forwards';
              
              if(targetId === 'teacher-door') {
                queryDeviceStatus();
              } else if(targetId === 'student-qrcode') {
                loadStudentQRCode();
              } else if(targetId === 'teacher-qrcode') {
                loadTeacherQRCode();
              } else if(targetId === 'teacher-exception') {
                setTimeout(() => {
                  fetchDeviceVariables();
                }, 100);
              } else if(targetId === 'student-history') {
                fetchDeviceVariables();
              }
            }, 300);
          }
        });
      });
      
      // 设备状态查询
      const deviceStatusInterval = setInterval(fetchDeviceVariables, 1000);
      fetchDeviceVariables();
      
      // 从OneNet API获取设备变量
      async function fetchDeviceVariables() {
        try {
          const apiUrl = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            // 保存之前的use_flag状态
            const oldUseFlag = deviceVariables.use_flag;
            const oldErrorFlag = deviceVariables.错误标志;
            
            const useFlagProperty = properties.find(prop => prop.identifier === 'use_flag');
            const equipmentTypeProperty = properties.find(prop => prop.identifier === 'equipment_type');
            const useTimeProperty = properties.find(prop => prop.identifier === 'use_time');
            const errorFlagProperty = properties.find(prop => prop.identifier === '错误标志');
            const cabinetProperty = properties.find(prop => prop.identifier === 'cabinet');
            const lock1Property = properties.find(prop => prop.identifier === 'Lock1');
            const lock2Property = properties.find(prop => prop.identifier === 'Lock2');
            const lock3Property = properties.find(prop => prop.identifier === 'Lock3');
            
            if (useFlagProperty) {
              deviceVariables.use_flag = convertToBoolean(useFlagProperty.value);
              
              // 更新使用状态显示
              const useFlagDisplay = document.getElementById('current-use-flag');
              if (useFlagDisplay) {
                useFlagDisplay.textContent = deviceVariables.use_flag.toString();
                // 改变颜色来突显状态
                if (deviceVariables.use_flag) {
                  useFlagDisplay.style.color = '#28a745';
                  useFlagDisplay.style.backgroundColor = '#e5f9ee';
                } else {
                  useFlagDisplay.style.color = '#007bff';
                  useFlagDisplay.style.backgroundColor = '#e9f5ff';
                }
              }
            }
            
            if (equipmentTypeProperty) {
              deviceVariables.equipment_type = parseInt(equipmentTypeProperty.value) || 0;
              
              // 更新器材类型显示
              const equipmentTypeDisplay = document.getElementById('current-student-equipment-type');
              if (equipmentTypeDisplay) {
                let equipmentName = '乒乓球';
                if (deviceVariables.equipment_type === 1) {
                  equipmentName = '跳绳';
                } else if (deviceVariables.equipment_type === 2) {
                  equipmentName = '篮球';
                }
                equipmentTypeDisplay.textContent = equipmentName;
              }
              
              const equipmentTypeDisplay2 = document.getElementById('current-equipment-type');
              if (equipmentTypeDisplay2) {
                let equipmentName = '乒乓球';
                if (deviceVariables.equipment_type === 1) {
                  equipmentName = '跳绳';
                } else if (deviceVariables.equipment_type === 2) {
                  equipmentName = '篮球';
                }
                equipmentTypeDisplay2.textContent = equipmentName;
              }
            }
            
            if (useTimeProperty) {
              deviceVariables.use_time = parseFloat(useTimeProperty.value) || 0;
              
              // 更新使用时长显示
              const useTimeDisplay = document.getElementById('current-use-time');
              if (useTimeDisplay) {
                useTimeDisplay.textContent = deviceVariables.use_time.toString();
              }
            }
            
            if (errorFlagProperty) {
              deviceVariables.错误标志 = parseInt(errorFlagProperty.value) || 0;
              
              // 更新错误标志显示
              const errorFlagDisplay = document.getElementById('current-error-flag');
              if (errorFlagDisplay) {
                errorFlagDisplay.textContent = deviceVariables.错误标志;
              }
            } else {
              // 简化错误标志处理逻辑，移除调试信息
              let foundErrorProperty = properties.find(prop => 
                prop.identifier === 'error_flag' || 
                prop.identifier === 'ErrorFlag' || 
                prop.identifier === 'errorFlag'
              );
              
              if (foundErrorProperty) {
                deviceVariables.错误标志 = parseInt(foundErrorProperty.value) || 0;
                
                // 更新错误标志显示
                const errorFlagDisplay = document.getElementById('current-error-flag');
                if (errorFlagDisplay) {
                  errorFlagDisplay.textContent = deviceVariables.错误标志;
                }
              }
            }
            
            if (cabinetProperty) {
              deviceVariables.cabinet = parseInt(cabinetProperty.value) || 0;
              
              // 更新柜子号显示
              const cabinetDisplay = document.getElementById('current-cabinet');
              if (cabinetDisplay) {
                cabinetDisplay.textContent = deviceVariables.cabinet;
              }
            }
            
            if (lock1Property) {
              deviceVariables.Lock1 = convertToBoolean(lock1Property.value);
              updateLockDisplay(1, deviceVariables.Lock1);
            }
            
            if (lock2Property) {
              deviceVariables.Lock2 = convertToBoolean(lock2Property.value);
              updateLockDisplay(2, deviceVariables.Lock2);
            }
            
            if (lock3Property) {
              deviceVariables.Lock3 = convertToBoolean(lock3Property.value);
              updateLockDisplay(3, deviceVariables.Lock3);
            }
            
            // 检查错误标志变化并添加记录
            if (oldErrorFlag !== deviceVariables.错误标志 && deviceVariables.错误标志 !== 0) {
              const errorId = deviceVariables.错误标志.toString();
              // 只处理特定的错误ID
              if (errorId === '210797' || errorId === '175905' || errorId === '175908') {
                addExceptionRecord(errorId);
              }
            }
            
            // 检查use_flag的变化并更新历史记录
            const currentDateStr = getCurrentDateString();
            const historyTableBody = document.getElementById('history-table-body');
            
            if (historyTableBody) {
              // 当use_flag从false变为true时添加或更新记录
              if (oldUseFlag === false && deviceVariables.use_flag === true) {
                console.log('检测到使用状态变化: false -> true，更新历史记录');
                const existingTodayRow = findTodayRow(historyTableBody, currentDateStr);
                
                if (existingTodayRow) {
                  // 如果今天已有记录，则更新该记录
                  updateHistoryRow(existingTodayRow);
                } else {
                  // 否则创建新记录
                  insertNewHistoryRecord(currentDateStr);
                }
              }
            }
            
            // 保存当前状态用于下次比较
            previousUseFlag = deviceVariables.use_flag;
            
            return true;
          } else {
            console.error('设备状态查询失败:', data.msg || '未知错误');
            return false;
          }
        } catch (error) {
          console.error('获取设备状态失败:', error);
          document.getElementById('lock1-status').textContent = '门1状态: 查询出错';
          document.getElementById('lock2-status').textContent = '门2状态: 查询出错';
          document.getElementById('lock3-status').textContent = '门3状态: 查询出错';
          return false;
        }
      }
      
      // 添加异常记录函数
      function addExceptionRecord(errorId) {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        // 获取用户信息
        const userName = userNameMap[errorId] || '未知用户';
        
        // 获取当前日期
        const today = getCurrentDateString();
        
        // 获取柜子编号
        const cabinetNumber = deviceVariables.cabinet || 1;
        
        // 获取器材类型
        let equipmentName = '乒乓球';
        if (deviceVariables.equipment_type === 1) {
          equipmentName = '跳绳';
        } else if (deviceVariables.equipment_type === 2) {
          equipmentName = '篮球';
        }
        
        // 创建新的表格行
        const newRow = document.createElement('tr');
        newRow.style.animation = 'fadeInUp 0.5s ease-out';
        
        // 闪烁效果，突出显示新记录
        setTimeout(() => {
          newRow.style.backgroundColor = '';
          newRow.style.transition = 'background-color 2s ease';
        }, 2000);
        
        newRow.innerHTML = `
          <td>${errorId}</td>
          <td>${userName}</td>
          <td>${today}</td>
          <td>${cabinetNumber}</td>
          <td>${equipmentName}</td>
          <td class="status-cell" data-status="pending" style="animation: pulse 1s ease-out;">未处理</td>
        `;
        
        // 添加到表格顶部
        if (exceptionTableBody.firstChild) {
          exceptionTableBody.insertBefore(newRow, exceptionTableBody.firstChild);
        } else {
          exceptionTableBody.appendChild(newRow);
        }
        
        // 绑定状态单元格点击事件
        const statusCell = newRow.querySelector('.status-cell');
        if (statusCell) {
          statusCell.addEventListener('click', function() {
            const currentStatus = this.getAttribute('data-status');
            const newStatus = currentStatus === 'done' ? 'pending' : 'done';
            
            // 添加点击动画效果
            this.style.animation = 'pulse 0.5s';
            setTimeout(() => {
              this.style.animation = '';
            }, 500);
            
            // 更新状态文本和属性
            this.setAttribute('data-status', newStatus);
            this.textContent = newStatus === 'done' ? '已处理' : '未处理';
            
            // 确保颜色样式正确应用
            if (newStatus === 'pending') {
              this.style.color = '#dc3545';
              this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
            } else {
              this.style.color = '#28a745';
              this.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
            }
          });
        }
      }
      
      // 历史记录相关函数
      function findTodayRow(tableBody, dateStr) {
        for (let i = 0; i < tableBody.rows.length; i++) {
          const row = tableBody.rows[i];
          const dateCell = row.cells[0];
          if (dateCell && dateCell.textContent === dateStr) {
            return row;
          }
        }
        return null;
      }
      
      function updateHistoryRow(row) {
        if (!row) return;
        
        const equipmentCell = row.cells[1];
        const durationCell = row.cells[2];
        
        // 获取当前设备使用的器材名称
        let currentEquipment = '乒乓球';
        if (deviceVariables.equipment_type === 1) {
          currentEquipment = '跳绳';
        } else if (deviceVariables.equipment_type === 2) {
          currentEquipment = '篮球';
        }
        
        // 更新器材显示：如果不同则添加新器材，用逗号分隔
        if (!equipmentCell.textContent.includes(currentEquipment)) {
          if (equipmentCell.textContent.trim() !== '') {
            equipmentCell.textContent = equipmentCell.textContent + ', ' + currentEquipment;
          } else {
            equipmentCell.textContent = currentEquipment;
          }
        }
        
        // 更新使用时长：累加当前时长
        const currentDuration = parseFloat(durationCell.textContent) || 0;
        const newDuration = currentDuration + deviceVariables.use_time;
        durationCell.textContent = newDuration.toFixed(1);
        
        // 更新总时长统计
        updateTotalHours();
      }
      
      function insertNewHistoryRecord(dateStr) {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return null;
        
        if (!dateStr) dateStr = getCurrentDateString();
        
        // 检查是否已存在当天的记录
        const existingRow = findTodayRow(historyTableBody, dateStr);
        if (existingRow) {
          updateHistoryRow(existingRow);
          return existingRow;
        }
        
        // 获取当前器材名称
        let equipment = '乒乓球';
        if (deviceVariables.equipment_type === 1) {
          equipment = '跳绳';
        } else if (deviceVariables.equipment_type === 2) {
          equipment = '篮球';
        }
        
        // 创建新记录行
        const newRow = document.createElement('tr');
        newRow.innerHTML = `<td>${dateStr}</td><td>${equipment}</td><td>${deviceVariables.use_time.toFixed(1)}</td>`;
        
        // 插入到表格顶部
        if (historyTableBody.firstChild) {
          historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
        } else {
          historyTableBody.appendChild(newRow);
        }
        
        // 更新总时长统计
        updateTotalHours();
        return newRow;
      }
      
      function updateTotalHours() {
        const totalHoursElement = document.getElementById('total-year-hours');
        if (!totalHoursElement) return;
        
        const hours = Array.from(document.querySelectorAll('#student-history tbody td:nth-child(3)'))
          .map(td => parseFloat(td.textContent) || 0);
        
        const totalHours = hours.reduce((sum, hour) => sum + hour, 0);
        totalHoursElement.textContent = totalHours.toFixed(1);
      }
      
      // 登录切换和验证
      document.getElementById('student-tab').addEventListener('click', () => toggleLoginPanels('student'));
      document.getElementById('teacher-tab').addEventListener('click', () => toggleLoginPanels('teacher'));
      
      function toggleLoginPanels(userType) {
        const isStudent = userType === 'student';
        document.getElementById('student-login').classList.toggle('hidden', !isStudent);
        document.getElementById('teacher-login').classList.toggle('hidden', isStudent);
        document.getElementById('student-tab').classList.toggle('active', isStudent);
        document.getElementById('teacher-tab').classList.toggle('active', !isStudent);
      }
      
      let currentLogin = {
        student: { username: '210797', password: '210797' },
        teacher: { username: '359921', password: '359921' }
      };
      
      document.getElementById('student-login-btn').addEventListener('click', () => login('student'));
      document.getElementById('teacher-login-btn').addEventListener('click', () => login('teacher'));
      
      function login(userType) {
        const username = document.getElementById(userType + '-username').value;
        const password = document.getElementById(userType + '-password').value;
        
        const credentials = {
          student: {username: '210797', password: '210797'},
          teacher: {username: '359921', password: '359921'},
          '175905': {type: 'student', password: '175905'},
          '175908': {type: 'student', password: '175908'}
        };
        
        let loginSuccess = false;
        let dashboardType = '';
        
        if (userType === 'student' && username === credentials.student.username && 
            password === credentials.student.password) {
          loginSuccess = true;
          dashboardType = 'student';
          currentLogin.student = { username, password };
        } 
        else if (userType === 'teacher' && username === credentials.teacher.username && 
            password === credentials.teacher.password) {
          loginSuccess = true;
          dashboardType = 'teacher';
          currentLogin.teacher = { username, password };
        } 
        else if (credentials[username] && credentials[username].type === 'student' && 
            credentials[username].password === password) {
          loginSuccess = true;
          dashboardType = 'student';
          currentLogin.student = { username, password };
        }
        
        if (loginSuccess) {
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById(dashboardType + '-dashboard').classList.remove('hidden');
          
          const firstMenuBtn = document.querySelector('#' + dashboardType + '-dashboard .menu-btn');
          if (firstMenuBtn) firstMenuBtn.click();
        } else {
          alert(userType === 'student' ? '学生账号或密码错误!' : '教师账号或密码错误!');
        }
      }

      document.getElementById('student-logout').addEventListener('click', () => logout('student'));
      document.getElementById('teacher-logout').addEventListener('click', () => logout('teacher'));
      
      function logout(userType) {
        document.getElementById(userType + '-dashboard').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        
        if (userType === 'student') {
          document.getElementById('student-tab').click();
          document.getElementById('student-username').value = currentLogin.student.username;
          document.getElementById('student-password').value = currentLogin.student.password;
        } else {
          document.getElementById('teacher-tab').click();
          document.getElementById('teacher-username').value = currentLogin.teacher.username;
          document.getElementById('teacher-password').value = currentLogin.teacher.password;
        }
      }

      // 设备状态和控制
      let deviceStatus = {
        isLocked1: true,
        isLocked2: true,
        isLocked3: true,
        lastUpdateTime1: '',
        lastUpdateTime2: '',
        lastUpdateTime3: ''
      };
      
      async function queryDeviceStatus() {
        try {
          const url = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            const currentTime = new Date().toLocaleString();
            
            const lock1Property = properties.find(prop => prop.identifier === 'Lock1');
            const lock2Property = properties.find(prop => prop.identifier === 'Lock2');
            const lock3Property = properties.find(prop => prop.identifier === 'Lock3');
            
            if (lock1Property) {
              deviceStatus.isLocked1 = convertToBoolean(lock1Property.value);
              deviceStatus.lastUpdateTime1 = currentTime;
              updateLockDisplay(1, deviceStatus.isLocked1, deviceStatus.lastUpdateTime1);
            }
            
            if (lock2Property) {
              deviceStatus.isLocked2 = convertToBoolean(lock2Property.value);
              deviceStatus.lastUpdateTime2 = currentTime;
              updateLockDisplay(2, deviceStatus.isLocked2, deviceStatus.lastUpdateTime2);
            }
            
            if (lock3Property) {
              deviceStatus.isLocked3 = convertToBoolean(lock3Property.value);
              deviceStatus.lastUpdateTime3 = currentTime;
              updateLockDisplay(3, deviceStatus.isLocked3, deviceStatus.lastUpdateTime3);
            }
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '查询失败');
          }
        } catch (error) {
          console.error('查询设备状态失败:', error);
          document.getElementById('lock1-status').textContent = '门1状态: 查询出错';
          document.getElementById('lock2-status').textContent = '门2状态: 查询出错';
          document.getElementById('lock3-status').textContent = '门3状态: 查询出错';
          return false;
        }
      }
      
      async function setDeviceLockStatus(lockNumber, isLocked) {
        try {
          const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
          if (doorToggleBtn) doorToggleBtn.disabled = true;
          
          const requestData = {
            product_id: config.productId,
            device_name: config.deviceName,
            params: { [`Lock${lockNumber}`]: isLocked }
          };
          
          const response = await fetch(config.setApiUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': config.authorization
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.errno === 0 || data.code === 0) {
            deviceStatus[`isLocked${lockNumber}`] = isLocked;
            const currentTime = new Date().toLocaleString();
            deviceStatus[`lastUpdateTime${lockNumber}`] = currentTime;
            
            updateLockDisplay(lockNumber, isLocked, currentTime);
            
            setTimeout(() => queryDeviceStatus(), 2000);
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '设置失败');
          }
        } catch (error) {
          console.error(`设置门锁${lockNumber}状态失败:`, error);
          document.getElementById(`lock${lockNumber}-status`).textContent = `门${lockNumber}状态: 设置失败`;
          return false;
        } finally {
          const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
          if (doorToggleBtn) doorToggleBtn.disabled = false;
        }
      }
      
      document.getElementById('door1-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock1 || deviceStatus.isLocked1;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(1, newLockStatus);
      });
      
      document.getElementById('door2-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock2 || deviceStatus.isLocked2;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(2, newLockStatus);
      });
      
      document.getElementById('door3-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock3 || deviceStatus.isLocked3;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(3, newLockStatus);
      });
      
      // 二维码加载
      function loadStudentQRCode() {
        const studentUsername = document.getElementById('student-username').value || '210797';
        document.getElementById('qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${studentUsername}`;
      }

      function loadTeacherQRCode() {
        const teacherUsername = document.getElementById('teacher-username').value || '359921';
        document.getElementById('teacher-qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${teacherUsername}`;
      }

      // 更新门锁状态显示
      function updateLockDisplay(lockNumber, isLocked, updateTime) {
        const lockStatusElement = document.getElementById(`lock${lockNumber}-status`);
        if (lockStatusElement) {
          lockStatusElement.textContent = `门${lockNumber}状态: ${isLocked ? '已关门' : '已开门'}`;
        }
        
        const updateTimeElement = document.getElementById(`lock${lockNumber}-update-time`);
        if (updateTimeElement && updateTime) {
          updateTimeElement.textContent = `最后更新时间: ${updateTime}`;
        }
        
        const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
        if (doorToggleBtn) {
          doorToggleBtn.textContent = isLocked ? '已关门' : '已开门';
          doorToggleBtn.classList.remove('door-open', 'door-closed');
          doorToggleBtn.classList.add(isLocked ? 'door-closed' : 'door-open');
        }
        
        deviceStatus[`isLocked${lockNumber}`] = isLocked;
      }

      // 生成初始异常记录数据
      function generateInitialExceptionRecords() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        // 清空现有记录
        exceptionTableBody.innerHTML = '';
        
        // 示例数据
        const exceptionData = [
          { account: '201801', name: '张明', date: generateRecentDate(5), cabinet: 2, equipment: '乒乓球', status: 'done' },
          { account: '201802', name: '李华', date: generateRecentDate(12), cabinet: 1, equipment: '跳绳', status: 'done' },
          { account: '201803', name: '王芳', date: generateRecentDate(19), cabinet: 3, equipment: '篮球', status: 'done' },
          { account: '201804', name: '赵强', date: generateRecentDate(26), cabinet: 2, equipment: '乒乓球', status: 'done' },
          { account: '201805', name: '陈静', date: generateRecentDate(33), cabinet: 1, equipment: '篮球', status: 'done' },
          { account: '201806', name: '杨光', date: generateRecentDate(40), cabinet: 3, equipment: '跳绳', status: 'done' },
          { account: '201807', name: '周敏', date: generateRecentDate(47), cabinet: 2, equipment: '篮球', status: 'done' },
          { account: '201808', name: '吴强', date: generateRecentDate(54), cabinet: 1, equipment: '乒乓球', status: 'done' }
        ];
        
        // 添加记录到表格
        exceptionData.forEach((record, index) => {
          const row = document.createElement('tr');
          row.style.animation = `fadeInUp ${0.3 + index * 0.1}s ease-out`;
          
          row.innerHTML = `
            <td>${record.account}</td>
            <td>${record.name}</td>
            <td>${record.date}</td>
            <td>${record.cabinet}</td>
            <td>${record.equipment}</td>
            <td class="status-cell" data-status="${record.status}">${record.status === 'done' ? '已处理' : '未处理'}</td>
          `;
          
          exceptionTableBody.appendChild(row);
        });
        
        // 绑定状态单元格点击事件
        document.querySelectorAll('.status-cell').forEach(cell => {
          cell.addEventListener('click', function() {
            const currentStatus = this.getAttribute('data-status');
            const newStatus = currentStatus === 'done' ? 'pending' : 'done';
            
            // 添加点击动画效果
            this.style.animation = 'pulse 0.5s';
            setTimeout(() => {
              this.style.animation = '';
            }, 500);
            
            // 更新状态文本和属性
            this.setAttribute('data-status', newStatus);
            this.textContent = newStatus === 'done' ? '已处理' : '未处理';
            
            // 确保颜色样式正确应用
            if (newStatus === 'pending') {
              this.style.color = '#dc3545';
              this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
            } else {
              this.style.color = '#28a745';
              this.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
            }
          });
        });
      }
    });
  </script>
</body>
</html>