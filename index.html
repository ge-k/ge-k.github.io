<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>校园运动器材管理系统</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', sans-serif;
    }
    body {
      background-color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 1000px;
      padding: 20px;
    }
    .card {
      background-color: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      width: 100%;
    }
    button:hover {
      background-color: #0069d9;
    }
    .hidden {
      display: none;
    }
    .menu {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .menu button {
      width: auto;
    }
    .tab-panel {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .login-tab {
      padding: 10px 20px;
      border: none;
      background-color: #f1f1f1;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      margin: 0 5px;
      font-weight: bold;
      flex: 1;
      max-width: 150px;
    }
    .login-tab.active {
      background-color: #007bff;
      color: white;
    }
    .login-panel {
      padding: 20px;
      border-radius: 5px;
      background-color: #ffffff;
    }
    .device-info {
      margin: 20px 0;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }
    .device-info p {
      margin-bottom: 8px;
      font-size: 16px;
    }
    .result {
      font-size: 18px;
      margin: 10px 0;
      font-weight: bold;
    }
    .door-control {
      display: flex;
      margin-top: 20px;
    }
    .door-open {
      background-color: #28a745;
    }
    .door-closed {
      background-color: #dc3545;
    }
    
    /* 响应式设计，适应安卓屏幕 */
    @media screen and (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .card {
        padding: 15px;
      }
      .menu {
        flex-direction: column;
        gap: 10px;
      }
      table, th, td {
        padding: 8px;
        font-size: 14px;
      }
      h1 {
        font-size: 20px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 16px;
      }
      button {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      #login-section h3 {
        font-size: 18px;
        margin-bottom: 10px;
      }
      
      #login-section h1 {
        font-size: 22px;
      }

      /* 异常处理表格在中等屏幕的优化 */
      #teacher-exception table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
    
    /* 针对更小屏幕的手机 */
    @media screen and (max-width: 480px) {
      .card {
        padding: 10px;
      }
      table, th, td {
        padding: 6px;
        font-size: 12px;
      }
      .menu button {
        font-size: 12px;
        padding: 8px 12px;
      }
      h1 {
        font-size: 18px;
      }
      h2 {
        font-size: 16px;
      }
      h3 {
        font-size: 14px;
      }
      
      #login-section h3 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      #login-section h1 {
        font-size: 20px;
      }

      /* 异常处理表格在小屏幕的优化 */
      #teacher-exception th,
      #teacher-exception td {
        padding: 4px;
        font-size: 11px;
      }
    }
    
    /* 异常处理表格样式 */
    #teacher-exception table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    #teacher-exception table tr:hover {
      background-color: #f1f7ff;
    }
    
    #teacher-exception table th {
      background-color: #007bff;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    /* 搜索框样式 */
    .search-container {
      margin: 15px 0;
      display: flex;
      justify-content: flex-end;
    }
    
    .search-input {
      width: 100%;
      max-width: 300px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    
    @media screen and (max-width: 480px) {
      .search-input {
        max-width: 100%;
        font-size: 12px;
      }
    }

    /* 状态单元格样式 */
    .status-cell {
      cursor: pointer;
      font-weight: bold;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .status-cell[data-status="pending"] {
      color: #dc3545;
      background-color: rgba(220, 53, 69, 0.1);
    }

    .status-cell[data-status="done"] {
      color: #28a745;
      background-color: rgba(40, 167, 69, 0.1);
    }

    /* 添加动画关键帧 */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { 
        transform: translateY(-10px);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 登录界面 -->
    <div id="login-section" class="card">
      <h3 style="color: #007bff; font-family: 'Microsoft YaHei', sans-serif; margin-bottom: 15px; font-weight: 600; text-align: center; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,123,255,0.2); font-size: 22px; background: linear-gradient(45deg, #007bff, #00a8ff); -webkit-background-clip: text; color: transparent; -webkit-text-fill-color: transparent; padding: 5px; animation: fadeIn 1.5s ease-in-out;">2025共创芯未来</h3>
      <h1 style="font-size: 28px; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: slideIn 1s ease-out;">校园运动器材管理系统</h1>
      <div class="login-tabs">
        <button id="student-tab" class="login-tab active">学生登录</button>
        <button id="teacher-tab" class="login-tab">教师登录</button>
      </div>
      
      <div id="student-login" class="login-panel">
        <div class="form-group">
          <label for="student-username">账号</label>
          <input type="text" id="student-username" value="210797">
        </div>
        <div class="form-group">
          <label for="student-password">密码</label>
          <input type="password" id="student-password" value="210797">
        </div>
        <button id="student-login-btn">登录</button>
      </div>
      
      <div id="teacher-login" class="login-panel hidden">
        <div class="form-group">
          <label for="teacher-username">账号</label>
          <input type="text" id="teacher-username" value="359921">
        </div>
        <div class="form-group">
          <label for="teacher-password">密码</label>
          <input type="password" id="teacher-password" value="359921">
        </div>
        <button id="teacher-login-btn">登录</button>
      </div>
    </div>

    <!-- 学生功能界面 -->
    <div id="student-dashboard" class="card hidden">
      <h1>学生功能界面</h1>
      <div class="menu">
        <button class="menu-btn" data-target="student-history">历史记录</button>
        <button class="menu-btn" data-target="student-qrcode">查看二维码</button>
        <button id="student-logout">退出登录</button>
      </div>

      <!-- 历史记录界面 -->
      <div id="student-history" class="tab-panel">
        <h2>历史使用记录</h2>
        <div>一月总使用时长: <span id="total-year-hours">21</span> 小时</div>
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>器材</th>
              <th>使用时长 (小时)</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td>2025-03-30</td><td>乒乓球</td><td>2.5</td></tr>
            <tr><td>2025-03-27</td><td>跳绳</td><td>1.5</td></tr>
            <tr><td>2025-03-25</td><td>乒乓球</td><td>2</td></tr>
            <tr><td>2025-03-21</td><td>跳绳</td><td>1.5</td></tr>
            <tr><td>2025-03-18</td><td>乒乓球</td><td>3</td></tr>
            <tr><td>2025-03-15</td><td>跳绳</td><td>2</td></tr>
            <tr><td>2025-03-12</td><td>乒乓球</td><td>2.5</td></tr>
            <tr><td>2025-03-09</td><td>跳绳</td><td>1</td></tr>
            <tr><td>2025-03-05</td><td>乒乓球</td><td>3</td></tr>
            <tr><td>2025-03-01</td><td>跳绳</td><td>2</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 二维码界面 -->
      <div id="student-qrcode" class="tab-panel">
        <h2>学生二维码</h2>
        <div style="text-align: center; margin: 20px 0;">
          <p style="margin-bottom: 15px; font-size: 18px;">个人识别二维码</p>
          <div>
            <img id="qrcode-image" alt="学生二维码" style="border: 1px solid #ddd; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          </div>
          <p style="margin-top: 15px; color: #666; font-size: 14px;">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>

    <!-- 教师功能界面 -->
    <div id="teacher-dashboard" class="card hidden">
      <h1>教师功能界面</h1>
      <div class="menu">
        <button class="menu-btn" data-target="teacher-door">开关门柜</button>
        <button class="menu-btn" data-target="teacher-exception">异常处理</button>
        <button class="menu-btn" data-target="teacher-qrcode">查看二维码</button>
        <button id="teacher-logout">退出登录</button>
      </div>

      <!-- 开关门柜界面 -->
      <div id="teacher-door" class="tab-panel">
        <h2>开关门柜管理</h2>
        <div class="form-group door-control">
          <button id="door-toggle" style="width: 120px;">加载中...</button>
        </div>
        
        <div class="device-info">
          <h3>设备状态</h3>
          <p class="result" id="lock-status">门状态: 查询中...</p>
          <p class="result" id="last-update-time">最后更新时间: 查询中...</p>
        </div>
      </div>

      <!-- 异常处理界面 -->
      <div id="teacher-exception" class="tab-panel">
        <h2>归还超时记录</h2>
        <div class="search-container">
          <input type="text" id="exception-search" placeholder="搜索..." class="search-input">
        </div>
        <table>
          <thead>
            <tr>
              <th>账号</th>
              <th>姓名</th>
              <th>时期</th>
              <th>柜子</th>
              <th>器材</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody id="exception-table-body">
            <tr>
              <td>175905</td><td>孙八</td><td id="current-month-date-1"></td><td>2</td><td>乒乓球</td><td class="status-cell" data-status="pending">未处理</td>
            </tr>
            <tr>
              <td>210890</td><td>王一</td><td id="current-month-date-2"></td><td>1</td><td>乒乓球</td><td class="status-cell" data-status="pending">未处理</td>
            </tr>
            <tr>
              <td>210667</td><td>王五</td><td id="current-month-date-3"></td><td>2</td><td>跳绳</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>210333</td><td>吴九</td><td id="current-month-date-4"></td><td>3</td><td>乒乓球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>210456</td><td>周八</td><td id="current-month-date-5"></td><td>1</td><td>跳绳</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 教师二维码界面 -->
      <div id="teacher-qrcode" class="tab-panel">
        <h2>教师二维码</h2>
        <div style="text-align: center; margin: 20px 0;">
          <p style="margin-bottom: 15px; font-size: 18px;">教师识别二维码</p>
          <div>
            <img id="teacher-qrcode-image" alt="教师二维码" style="border: 1px solid #ddd; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          </div>
          <p style="margin-top: 15px; color: #666; font-size: 14px;">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 设置默认账号密码
      document.getElementById('student-username').value = '210797';
      document.getElementById('student-password').value = '210797';
      document.getElementById('teacher-username').value = '359921';
      document.getElementById('teacher-password').value = '359921';
      
      // 设备状态变量
      let deviceVariables = {
        use_flag: false,
        ping_pong: false,
        use_time: 0,
        error_flag: 0,
        cabinet: 0,
        lock: false
      };
      
      // OneNet物联网平台API配置
      const config = {
        productId: '56i5KnK1KX',
        deviceName: 'ch32',
        authorization: 'version=2018-10-31&res=products%2F56i5KnK1KX%2Fdevices%2Fch32&et=1767233340&method=md5&sign=xTIiV6aZQvvpq1yJti58tQ%3D%3D',
        queryApiUrl: 'https://iot-api.heclouds.com/thingmodel/query-device-property',
        setApiUrl: 'https://iot-api.heclouds.com/thingmodel/set-device-desired-property'
      };
      
      // 更新异常处理界面的借走日期为当月日期
      function updateExceptionDates() {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth() + 1;
        const currentDay = today.getDate();
        
        const date1 = document.getElementById('current-month-date-1');
        const date2 = document.getElementById('current-month-date-2');
        const date3 = document.getElementById('current-month-date-3');
        const date4 = document.getElementById('current-month-date-4');
        const date5 = document.getElementById('current-month-date-5');
        
        const day1 = currentDay;
        const day2 = Math.max(1, currentDay - 3);
        const day3 = Math.max(1, currentDay - 7);
        const day4 = Math.max(1, currentDay - 12);
        const day5 = Math.max(1, currentDay - 14);
        
        if (date1) date1.textContent = formatDate(currentYear, currentMonth, day1);
        if (date2) date2.textContent = formatDate(currentYear, currentMonth, day2);
        if (date3) date3.textContent = formatDate(currentYear, currentMonth, day3);
        if (date4) date4.textContent = formatDate(currentYear, currentMonth, day4);
        if (date5) date5.textContent = formatDate(currentYear, currentMonth, day5);
        
        updatePastRecordsStatus();
      }
      
      // 更新过去记录的状态
      function updatePastRecordsStatus() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const rows = exceptionTableBody.querySelectorAll('tr');
        rows.forEach(row => {
          const dateCell = row.cells[2];
          const statusCell = row.cells[5];
          
          if (dateCell && statusCell) {
            const dateStr = dateCell.textContent;
            const recordDate = new Date(dateStr);
            recordDate.setHours(0, 0, 0, 0);
            
            if (recordDate < today) {
              statusCell.textContent = "已处理";
              statusCell.setAttribute('data-status', 'done');
            }
          }
        });
      }
      
      // 辅助函数
      function convertToBoolean(value) {
        if (typeof value === 'boolean') return value;
        if (value === 'true' || value === '1' || value === 1) return true;
        if (value === 'false' || value === '0' || value === 0) return false;
        return Boolean(value);
      }
      
      function getCurrentDateString() {
        const today = new Date();
        return today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
      }
      
      function formatDate(year, month, day) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
      
      // 初始化调用
      updateExceptionDates();
      
      // 界面切换事件
      document.querySelectorAll('.menu-btn').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const dashboard = this.closest('.card');
          
          dashboard.querySelectorAll('.tab-panel').forEach(panel => {
            panel.style.display = 'none';
          });
          
          if(targetId) {
            document.getElementById(targetId).style.display = 'block';
            
            if(targetId === 'teacher-door') {
              queryDeviceStatus();
            } else if(targetId === 'student-qrcode') {
              loadStudentQRCode();
            } else if(targetId === 'teacher-qrcode') {
              loadTeacherQRCode();
            } else if(targetId === 'teacher-exception') {
              setTimeout(() => {
                updateExceptionDates();
                fetchDeviceVariables();
              }, 100);
            } else if(targetId === 'student-history') {
              document.getElementById('student-history').style.display = 'block';
              fetchDeviceVariables();
            }
          }
        });
      });
      
      // 设备状态查询
      const deviceStatusInterval = setInterval(fetchDeviceVariables, 1000);
      fetchDeviceVariables();
      
      // 从OneNet API获取设备变量
      async function fetchDeviceVariables() {
        try {
          const apiUrl = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            const oldUseFlag = deviceVariables.use_flag;
            const oldErrorFlag = deviceVariables.error_flag;
            
            const useFlagProperty = properties.find(prop => prop.identifier === 'use_flag');
            const pingPongProperty = properties.find(prop => prop.identifier === 'ping_pong');
            const useTimeProperty = properties.find(prop => prop.identifier === 'use_time');
            const errorFlagProperty = properties.find(prop => prop.identifier === 'error_flag');
            const cabinetProperty = properties.find(prop => prop.identifier === 'cabinet');
            const lockProperty = properties.find(prop => prop.identifier === 'Lock' || prop.identifier === 'lock');
            
            if (useFlagProperty) {
              deviceVariables.use_flag = convertToBoolean(useFlagProperty.value);
            }
            
            if (pingPongProperty) {
              deviceVariables.ping_pong = convertToBoolean(pingPongProperty.value);
            }
            
            if (useTimeProperty) {
              deviceVariables.use_time = parseFloat(useTimeProperty.value) || 0;
            }
            
            if (errorFlagProperty) {
              deviceVariables.error_flag = parseInt(errorFlagProperty.value) || 0;
            }
            
            if (cabinetProperty) {
              deviceVariables.cabinet = parseInt(cabinetProperty.value) || 0;
            }
            
            if (lockProperty) {
              deviceVariables.lock = convertToBoolean(lockProperty.value);
              updateLockDisplay(deviceVariables.lock);
            }
            
            if (oldErrorFlag !== deviceVariables.error_flag && deviceVariables.error_flag !== 0) {
              insertExceptionRecord();
            }
            
            const currentDateStr = getCurrentDateString();
            const historyTableBody = document.getElementById('history-table-body');
            
            if (historyTableBody) {
              const existingRow = findTodayRow(historyTableBody, currentDateStr);
              
              if (oldUseFlag === false && deviceVariables.use_flag === true) {
                if (existingRow) {
                  updateHistoryRow(existingRow);
                } else {
                  insertNewHistoryRecord(currentDateStr);
                }
              } else if (deviceVariables.use_flag === true && existingRow) {
                updateHistoryRow(existingRow);
              }
            }
            
            return true;
          } else {
            console.error('设备状态查询失败:', data.msg || '未知错误');
            return false;
          }
        } catch (error) {
          console.error('获取设备状态失败:', error);
          return false;
        }
      }
      
      // 历史记录相关函数
      function findTodayRow(tableBody, dateStr) {
        for (let i = 0; i < tableBody.rows.length; i++) {
          const row = tableBody.rows[i];
          const dateCell = row.cells[0];
          if (dateCell && dateCell.textContent === dateStr) {
            return row;
          }
        }
        return null;
      }
      
      function updateHistoryRow(row) {
        if (!row) return;
        
        const equipmentCell = row.cells[1];
        const equipment = deviceVariables.ping_pong ? '乒乓球' : '跳绳';
        if (equipmentCell.textContent !== equipment) {
          equipmentCell.textContent = equipment;
        }
        
        const durationCell = row.cells[2];
        if (parseFloat(durationCell.textContent) !== deviceVariables.use_time) {
          durationCell.textContent = deviceVariables.use_time;
          updateTotalHours();
        }
      }
      
      function insertNewHistoryRecord(dateStr) {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return null;
        
        if (!dateStr) dateStr = getCurrentDateString();
        
        const existingRow = findTodayRow(historyTableBody, dateStr);
        if (existingRow) {
          updateHistoryRow(existingRow);
          return existingRow;
        }
        
        const equipment = deviceVariables.ping_pong ? '乒乓球' : '跳绳';
        const newRow = document.createElement('tr');
        newRow.innerHTML = `<td>${dateStr}</td><td>${equipment}</td><td>${deviceVariables.use_time}</td>`;
        
        if (historyTableBody.firstChild) {
          historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
        } else {
          historyTableBody.appendChild(newRow);
        }
        
        updateTotalHours();
        return newRow;
      }
      
      function updateTotalHours() {
        const totalHoursElement = document.getElementById('total-year-hours');
        if (!totalHoursElement) return;
        
        const hours = Array.from(document.querySelectorAll('#student-history tbody td:nth-child(3)'))
          .map(td => parseFloat(td.textContent) || 0);
        
        const totalHours = hours.reduce((sum, hour) => sum + hour, 0);
        totalHoursElement.textContent = totalHours.toFixed(1);
      }
      
      // 登录切换和验证
      document.getElementById('student-tab').addEventListener('click', () => toggleLoginPanels('student'));
      document.getElementById('teacher-tab').addEventListener('click', () => toggleLoginPanels('teacher'));
      
      function toggleLoginPanels(userType) {
        const isStudent = userType === 'student';
        document.getElementById('student-login').classList.toggle('hidden', !isStudent);
        document.getElementById('teacher-login').classList.toggle('hidden', isStudent);
        document.getElementById('student-tab').classList.toggle('active', isStudent);
        document.getElementById('teacher-tab').classList.toggle('active', !isStudent);
      }
      
      let currentLogin = {
        student: { username: '210797', password: '210797' },
        teacher: { username: '359921', password: '359921' }
      };
      
      document.getElementById('student-login-btn').addEventListener('click', () => login('student'));
      document.getElementById('teacher-login-btn').addEventListener('click', () => login('teacher'));
      
      function login(userType) {
        const username = document.getElementById(userType + '-username').value;
        const password = document.getElementById(userType + '-password').value;
        
        const credentials = {
          student: {username: '210797', password: '210797'},
          teacher: {username: '359921', password: '359921'},
          '175905': {type: 'student', password: '175905'},
          '175908': {type: 'student', password: '175908'}
        };
        
        let loginSuccess = false;
        let dashboardType = '';
        
        if (userType === 'student' && username === credentials.student.username && 
            password === credentials.student.password) {
          loginSuccess = true;
          dashboardType = 'student';
          currentLogin.student = { username, password };
        } 
        else if (userType === 'teacher' && username === credentials.teacher.username && 
            password === credentials.teacher.password) {
          loginSuccess = true;
          dashboardType = 'teacher';
          currentLogin.teacher = { username, password };
        } 
        else if (credentials[username] && credentials[username].type === 'student' && 
            credentials[username].password === password) {
          loginSuccess = true;
          dashboardType = 'student';
          currentLogin.student = { username, password };
        }
        
        if (loginSuccess) {
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById(dashboardType + '-dashboard').classList.remove('hidden');
          
          const firstMenuBtn = document.querySelector('#' + dashboardType + '-dashboard .menu-btn');
          if (firstMenuBtn) firstMenuBtn.click();
        } else {
          alert(userType === 'student' ? '学生账号或密码错误!' : '教师账号或密码错误!');
        }
      }

      document.getElementById('student-logout').addEventListener('click', () => logout('student'));
      document.getElementById('teacher-logout').addEventListener('click', () => logout('teacher'));
      
      function logout(userType) {
        document.getElementById(userType + '-dashboard').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        
        if (userType === 'student') {
          document.getElementById('student-tab').click();
          document.getElementById('student-username').value = currentLogin.student.username;
          document.getElementById('student-password').value = currentLogin.student.password;
        } else {
          document.getElementById('teacher-tab').click();
          document.getElementById('teacher-username').value = currentLogin.teacher.username;
          document.getElementById('teacher-password').value = currentLogin.teacher.password;
        }
      }

      // 设备状态和控制
      let deviceStatus = {
        isLocked: true,
        lastUpdateTime: ''
      };
      
      async function queryDeviceStatus() {
        try {
          const url = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            deviceStatus.lastUpdateTime = new Date().toLocaleString();
            
            const lockProperty = properties.find(prop => prop.identifier === 'Lock' || prop.identifier === 'lock');
            
            if (lockProperty) {
              const lockValue = lockProperty.value;
              deviceStatus.isLocked = Boolean(lockValue);
              updateLockDisplay(deviceStatus.isLocked);
            }
            
            document.getElementById('last-update-time').textContent = `最后更新时间: ${deviceStatus.lastUpdateTime}`;
            return true;
          } else {
            throw new Error(data.error || data.msg || '查询失败');
          }
        } catch (error) {
          console.error('查询设备状态失败:', error);
          document.getElementById('lock-status').textContent = '门状态: 查询出错';
          return false;
        }
      }
      
      async function setDeviceLockStatus(isLocked) {
        try {
          const doorToggleBtn = document.getElementById('door-toggle');
          doorToggleBtn.disabled = true;
          
          const requestData = {
            product_id: config.productId,
            device_name: config.deviceName,
            params: { Lock: isLocked }
          };
          
          const response = await fetch(config.setApiUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': config.authorization
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.errno === 0 || data.code === 0) {
            deviceStatus.isLocked = isLocked;
            deviceStatus.lastUpdateTime = new Date().toLocaleString();
            
            updateLockDisplay(isLocked);
            
            const lastUpdateTimeElement = document.getElementById('last-update-time');
            if (lastUpdateTimeElement) {
              lastUpdateTimeElement.textContent = `最后更新时间: ${deviceStatus.lastUpdateTime}`;
            }
            
            setTimeout(() => queryDeviceStatus(), 2000);
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '设置失败');
          }
        } catch (error) {
          console.error('设置门锁状态失败:', error);
          document.getElementById('lock-status').textContent = '门状态: 设置失败';
          return false;
        } finally {
          document.getElementById('door-toggle').disabled = false;
        }
      }
      
      document.getElementById('door-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.lock || deviceStatus.isLocked;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(newLockStatus);
      });
      
      // 二维码加载
      function loadStudentQRCode() {
        const studentUsername = document.getElementById('student-username').value || '210797';
        document.getElementById('qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${studentUsername}`;
      }

      function loadTeacherQRCode() {
        const teacherUsername = document.getElementById('teacher-username').value || '359921';
        document.getElementById('teacher-qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${teacherUsername}`;
      }

      // 异常记录处理
      function insertExceptionRecord() {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody || deviceVariables.error_flag === 0) return;
        
        const dateStr = getCurrentDateString();
        const cabinetNumber = deviceVariables.cabinet;
        const equipment = deviceVariables.ping_pong ? '乒乓球' : '跳绳';
        const account = deviceVariables.error_flag.toString();
        
        const names = ['张三', '李四', '王五', '赵六', '钱七', '孙八', '周九', '郑十', '吴一', '陈二'];
        const name = getRandomName(account, names);
        
        const rows = exceptionTableBody.querySelectorAll('tr');
        let accountExists = false;
        
        rows.forEach(row => {
          const accountCell = row.cells[0];
          const dateCell = row.cells[2];
          
          if (accountCell && dateCell && 
              accountCell.textContent === account && 
              dateCell.textContent === dateStr) {
            accountExists = true;
          }
        });
        
        if (accountExists) return;
        
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${account}</td>
          <td>${name}</td>
          <td>${dateStr}</td>
          <td>${cabinetNumber}</td>
          <td>${equipment}</td>
          <td class="status-cell" data-status="pending">未处理</td>
        `;
        
        if (exceptionTableBody.firstChild) {
          exceptionTableBody.insertBefore(newRow, exceptionTableBody.firstChild);
        } else {
          exceptionTableBody.appendChild(newRow);
        }
        
        updatePastRecordsStatus();
      }
      
      function getRandomName(account, names) {
        const seed = parseInt(account.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0));
        const index = seed % names.length;
        return names[index];
      }

      // 状态单元格点击事件
      const exceptionTableBody = document.getElementById('exception-table-body');
      if (exceptionTableBody) {
        exceptionTableBody.addEventListener('click', function(event) {
          const target = event.target;
          if (target.classList.contains('status-cell')) {
            const currentStatus = target.getAttribute('data-status');
            const newStatus = currentStatus === 'pending' ? 'done' : 'pending';
            
            target.setAttribute('data-status', newStatus);
            target.textContent = newStatus === 'pending' ? '未处理' : '已处理';
          }
        });
      }

      // 更新门锁状态显示
      function updateLockDisplay(isLocked) {
        const lockStatusElement = document.getElementById('lock-status');
        if (lockStatusElement) {
          lockStatusElement.textContent = `门状态: ${isLocked ? '已关门 (Lock = true)' : '已开门 (Lock = false)'}`;
        }
        
        const doorToggleBtn = document.getElementById('door-toggle');
        if (doorToggleBtn) {
          doorToggleBtn.textContent = isLocked ? '已关门' : '已开门';
          doorToggleBtn.classList.remove('door-open', 'door-closed');
          doorToggleBtn.classList.add(isLocked ? 'door-closed' : 'door-open');
        }
        
        deviceStatus.isLocked = isLocked;
      }
    });
  </script>
</body>
</html>