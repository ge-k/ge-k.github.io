<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>校园运动器材管理系统</title>
  <!-- 引入Google字体 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* 颜色变量 */
      --primary-color: #007bff;
      --primary-light: #e9f5ff;
      --primary-dark: #0056b3;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --success-light: #e5f9ee;
      --danger-color: #dc3545;
      --danger-light: #fae8ea;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --text-main: #333333;
      --text-secondary: #666666;
      --text-light: #999999;
      --border-color: #e9ecef;
      --background-color: #f5f5f5;
      --card-bg: #ffffff;
      
      /* 尺寸变量 */
      --border-radius: 12px;
      --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 12px 28px rgba(0, 0, 0, 0.15);
      --btn-shadow: 0 4px 10px rgba(0, 123, 255, 0.25);
      --transition-speed: 0.3s;
      
      /* 暗色模式变量（预设，后面会用） */
      --dark-bg: #1a1a1a;
      --dark-card-bg: #2d2d2d;
      --dark-text-main: #f8f9fa;
      --dark-text-secondary: #adb5bd;
      --dark-border-color: #444444;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Noto Sans SC', 'Roboto', 'Microsoft YaHei', sans-serif;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      background-color: var(--background-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-main);
      line-height: 1.6;
      margin: 0;
      transition: background-color var(--transition-speed) ease;
    }
    
    .container {
      width: 100%;
      max-width: 1100px;
      padding: 30px;
      margin: 20px auto;
      display: grid;
      gap: 30px;
    }
    
    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--card-shadow);
      transition: all var(--transition-speed) ease;
      overflow: hidden;
      animation: fadeIn 0.5s ease-out;
    }
    
    .card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-5px);
    }
    
    h1, h2, h3 {
      color: var(--text-main);
      margin-bottom: 25px;
      text-align: center;
      letter-spacing: 0.5px;
      font-weight: 700;
    }
    
    h1 {
      font-size: 28px;
      margin-top: 15px;
      position: relative;
    }
    
    h2 {
      font-size: 24px;
      color: var(--primary-color);
    }
    
    h3 {
      font-size: 20px;
      color: var(--secondary-color);
    }
    
    .branding {
      text-align: center;
      margin-bottom: 20px;
      animation: fadeIn 1.5s ease-in-out;
    }
    
    .branding-future {
      display: inline-block;
      color: transparent;
      background: linear-gradient(45deg, var(--primary-color), var(--info-color));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 600;
      font-size: 22px;
      margin-bottom: 10px;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
      animation: pulse 2s infinite alternate;
    }
    
    .branding-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.8px;
      margin: 0;
      position: relative;
      display: inline-block;
      padding: 0 10px;
      z-index: 1;
    }
    
    .branding-title::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background-color: rgba(0, 123, 255, 0.2);
      z-index: -1;
      border-radius: 4px;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--text-main);
      letter-spacing: 0.3px;
      transition: color 0.3s ease;
    }
    
    input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 16px;
      background-color: var(--light-color);
      color: var(--text-main);
      transition: all 0.3s ease;
    }
    
    input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
      outline: none;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px 24px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      width: 100%;
      box-shadow: var(--btn-shadow);
    }
    
    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0, 123, 255, 0.25);
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    button:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    .hidden {
      display: none;
    }
    
    .menu {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 35px;
      flex-wrap: wrap;
    }
    
    .menu button {
      flex: 1;
      min-width: 120px;
      max-width: 200px;
      padding: 12px 20px;
      border-radius: 10px;
    }
    
    .tab-panel {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 25px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }
    
    table, th, td {
      border: none;
    }
    
    th, td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    th {
      background-color: var(--light-color);
      font-weight: 600;
      color: var(--primary-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.01);
    }
    
    tr {
      transition: background-color 0.3s ease;
    }
    
    tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }
    
    .login-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .login-tab {
      padding: 14px 20px;
      border: none;
      background-color: var(--light-color);
      cursor: pointer;
      font-weight: 500;
      flex: 1;
      max-width: 180px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .login-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--primary-color);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .login-tab.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 123, 255, 0.25);
    }
    
    .login-tab:hover:not(.active) {
      background-color: rgba(0, 123, 255, 0.1);
    }
    
    .login-tab:hover::after {
      transform: scaleX(1);
    }
    
    .login-panel {
      padding: 30px;
      border-radius: 12px;
      background-color: var(--card-bg);
      animation: fadeIn 0.5s ease;
    }
    
    .device-info {
      margin: 25px 0;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: 10px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    .device-info:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .device-info p {
      margin-bottom: 12px;
      font-size: 16px;
    }
    
    .result {
      font-size: 18px;
      margin: 15px 0;
      font-weight: 600;
      color: var(--text-main);
      padding: 8px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    
    .door-control {
      display: flex;
      margin-top: 25px;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .door-open {
      background-color: var(--success-color);
    }
    
    .door-closed {
      background-color: var(--danger-color);
    }
    
    /* 响应式设计 */
    @media screen and (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 0;
        width: 100%;
        max-width: 100%;
      }
      
      .card {
        padding: 20px;
        border-radius: 8px;
      }
      
      .menu {
        flex-direction: column;
        gap: 15px;
      }
      
      .menu button {
        max-width: none;
        padding: 12px 12px;
      }
      
      .status-display {
        padding: 15px 10px;
      }
      
      .status-items {
        gap: 10px;
      }
      
      .status-item {
        width: 100%;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .status-label {
        margin-bottom: 5px;
      }
      
      .status-value {
        align-self: stretch;
        text-align: center;
      }
      
      .login-tabs {
        flex-direction: row;
      }
      
      .login-tab {
        padding: 12px 5px;
      }
      
      .qrcode-image-container {
        max-width: 85vw;
      }
      
      .qrcode-image {
        max-width: 100%;
        height: auto;
      }
      
      table, th, td {
        padding: 12px 8px;
        font-size: 14px;
      }
      
      input, button, select {
        font-size: 16px; /* 避免iOS自动缩放 */
      }
      
      h1 {
        font-size: 24px;
      }
      
      h2 {
        font-size: 20px;
      }
      
      h3 {
        font-size: 18px;
      }
      
      .branding-future {
        font-size: 18px;
      }
      
      .branding-title {
        font-size: 22px;
      }
      
      button {
        padding: 12px 18px;
        width: 100%;
      }
      
      /* 添加安卓特定的触摸反馈 */
      @media (hover: none) {
        button:active {
          background-color: var(--primary-dark);
        }
        
        .status-cell:active {
          opacity: 0.7;
        }
      }
    }
    
    /* 针对更小屏幕的手机 */
    @media screen and (max-width: 480px) {
      .card {
        padding: 15px;
        border-radius: 10px;
      }
      
      table, th, td {
        padding: 8px;
        font-size: 12px;
      }
      
      .menu button {
        font-size: 14px;
        padding: 10px 15px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      h2 {
        font-size: 18px;
      }
      
      h3 {
        font-size: 16px;
      }
      
      .branding-future {
        font-size: 16px;
      }
      
      .branding-title {
        font-size: 20px;
      }
      
      #login-section h3 {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      #login-section h1 {
        font-size: 20px;
      }
      
      #teacher-exception th,
      #teacher-exception td {
        padding: 6px;
        font-size: 11px;
      }
    }
    
    /* 状态单元格样式 */
    .status-cell {
      cursor: pointer;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
      display: inline-block;
      text-align: center;
    }
    
    .status-cell[data-status="pending"] {
      color: var(--danger-color);
      background-color: var(--danger-light);
      box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
    }
    
    .status-cell[data-status="done"] {
      color: var(--success-color);
      background-color: var(--success-light);
      box-shadow: 0 2px 5px rgba(40, 167, 69, 0.2);
    }
    
    .status-cell:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .status-cell:active {
      transform: translateY(1px);
    }
    
    /* 搜索框样式 */
    .search-container {
      margin: 15px 0 25px;
      display: flex;
      justify-content: flex-end;
    }
    
    .search-input {
      width: 100%;
      max-width: 300px;
      padding: 12px 18px;
      border: 1px solid var(--border-color);
      border-radius: 30px;
      font-size: 15px;
      transition: all 0.3s ease;
      background-color: var(--light-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
      transform: translateY(-2px);
    }
    
    /* 实时状态显示样式 */
    .status-display {
      margin: 20px 0;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .status-display:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      transform: translateY(-3px);
    }
    
    .status-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-items {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .status-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    }
    
    .status-label {
      margin-right: 10px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .status-value {
      font-size: 18px;
      font-weight: 600;
      padding: 5px 12px;
      border-radius: 8px;
    }
    
    .status-toggle {
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .status-toggle:hover {
      background-color: rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }
    
    .status-toggle:active {
      transform: translateY(1px);
    }
    
    /* QR码显示样式 */
    .qrcode-container {
      text-align: center;
      margin: 25px 0;
      padding: 20px;
    }
    
    .qrcode-title {
      margin-bottom: 20px;
      font-size: 20px;
      color: var(--text-main);
    }
    
    .qrcode-image-container {
      display: inline-block;
      padding: 15px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }
    
    .qrcode-image-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .qrcode-image {
      max-width: 100%;
      height: auto;
    }
    
    .qrcode-hint {
      margin-top: 20px;
      color: var(--text-secondary);
      font-size: 15px;
    }
    
    /* 动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulse {
      from { opacity: 0.8; transform: scale(1); }
      to { opacity: 1; transform: scale(1.03); }
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(30, 30);
        opacity: 0;
      }
    }
    
    /* 暗黑模式切换按钮 */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background-color: var(--card-bg);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .theme-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    
    .theme-toggle svg {
      width: 22px;
      height: 22px;
      color: var(--text-main);
      transition: all 0.3s ease;
    }
    
    /* 暗黑模式样式 */
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text-main);
    }
    
    body.dark-mode .card,
    body.dark-mode .login-panel {
      background-color: var(--dark-card-bg);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode h1, 
    body.dark-mode h2, 
    body.dark-mode h3 {
      color: var(--dark-text-main);
    }
    
    body.dark-mode .device-info,
    body.dark-mode .status-display {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: var(--dark-border-color);
    }
    
    body.dark-mode input {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: var(--dark-border-color);
      color: var(--dark-text-main);
    }
    
    body.dark-mode label,
    body.dark-mode .status-label {
      color: var(--dark-text-secondary);
    }
    
    body.dark-mode table {
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode th {
      background-color: rgba(0, 123, 255, 0.1);
    }
    
    body.dark-mode td {
      border-bottom-color: var(--dark-border-color);
    }
    
    body.dark-mode tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.02);
    }
    
    body.dark-mode tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    body.dark-mode .login-tab:not(.active) {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--dark-text-main);
    }
    
    body.dark-mode .login-tab:hover:not(.active) {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .search-input {
      background-color: rgba(255, 255, 255, 0.05);
      border-color: var(--dark-border-color);
      color: var(--dark-text-main);
    }
    
    body.dark-mode .status-item {
      background-color: rgba(255, 255, 255, 0.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-mode .theme-toggle {
      background-color: var(--dark-card-bg);
    }
    
    body.dark-mode .theme-toggle svg {
      color: var(--dark-text-main);
    }
  </style>
</head>
<body>
  <!-- 暗黑模式切换按钮 -->
  <div class="theme-toggle" id="theme-toggle">
    <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
  </div>

  <div class="container">
    <!-- 登录界面 -->
    <div id="login-section" class="card">
      <div class="branding">
        <div class="branding-future">2025共创芯未来</div>
        <h1 class="branding-title">校园运动器材管理系统</h1>
      </div>
      <div class="login-tabs">
        <button id="student-tab" class="login-tab active">学生登录</button>
        <button id="teacher-tab" class="login-tab">教师登录</button>
      </div>
      
      <div id="student-login" class="login-panel">
        <div class="form-group">
          <label for="student-username">账号</label>
          <input type="text" id="student-username" value="210797">
        </div>
        <div class="form-group">
          <label for="student-password">密码</label>
          <input type="password" id="student-password" value="210797">
        </div>
        <button id="student-login-btn">登录</button>
      </div>
      
      <div id="teacher-login" class="login-panel hidden">
        <div class="form-group">
          <label for="teacher-username">账号</label>
          <input type="text" id="teacher-username" value="359921">
        </div>
        <div class="form-group">
          <label for="teacher-password">密码</label>
          <input type="password" id="teacher-password" value="359921">
        </div>
        <button id="teacher-login-btn">登录</button>
      </div>
    </div>

    <!-- 学生功能界面 -->
    <div id="student-dashboard" class="card hidden">
      <div class="branding">
        <div class="branding-future">2025共创芯未来</div>
        <h1 class="branding-title">校园运动器材管理系统</h1>
      </div>
      <h2>学生功能界面</h2>
      <div class="menu">
        <button class="menu-btn" data-target="student-history">历史记录</button>
        <button class="menu-btn" data-target="student-qrcode">查看二维码</button>
        <button id="student-logout">退出登录</button>
      </div>

      <!-- 历史记录界面 -->
      <div id="student-history" class="tab-panel">
        <h2>历史使用记录</h2>
        <div class="total-hours">历史使用总时长: <span id="total-year-hours">21</span> 小时</div>
        
        <!-- 添加实时状态显示区域 -->
        <div class="status-display">
          <div class="status-title">实时设备状态</div>
          <div class="status-items">
            <div class="status-item">
              <span class="status-label">使用状态(use_flag):</span>
              <span id="current-use-flag" class="status-value" style="color: var(--primary-color); background: var(--primary-light);">false</span>
            </div>
            <div class="status-item">
              <span class="status-label">器材类型(equipment_type):</span>
              <span id="current-student-equipment-type" class="status-value" style="color: var(--success-color); background: var(--success-light);">乒乓球</span>
            </div>
            <div class="status-item">
              <span class="status-label">使用时长(use_time):</span>
              <span id="current-use-time" class="status-value" style="color: var(--danger-color); background: var(--danger-light);">0</span>
            </div>
          </div>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>器材</th>
              <th>使用时长 (小时)</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <!-- 历史记录将在JavaScript中动态生成 -->
          </tbody>
        </table>
      </div>

      <!-- 二维码界面 -->
      <div id="student-qrcode" class="tab-panel">
        <h2>学生二维码</h2>
        <div class="qrcode-container">
          <p class="qrcode-title">个人识别二维码</p>
          <div class="qrcode-image-container">
            <img id="qrcode-image" alt="学生二维码" class="qrcode-image">
          </div>
          <p class="qrcode-hint">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>

    <!-- 教师功能界面 -->
    <div id="teacher-dashboard" class="card hidden">
      <div class="branding">
        <div class="branding-future">2025共创芯未来</div>
        <h1 class="branding-title">校园运动器材管理系统</h1>
      </div>
      <h2>教师功能界面</h2>
      <div class="menu">
        <button class="menu-btn" data-target="teacher-door">开关门柜</button>
        <button class="menu-btn" data-target="teacher-exception">异常处理</button>
        <button class="menu-btn" data-target="teacher-qrcode">查看二维码</button>
        <button id="teacher-logout">退出登录</button>
      </div>

      <!-- 开关门柜界面 -->
      <div id="teacher-door" class="tab-panel">
        <h2>开关门柜管理</h2>
        <div class="door-control">
          <button id="door1-toggle" class="door-btn">加载中...</button>
          <button id="door2-toggle" class="door-btn">加载中...</button>
          <button id="door3-toggle" class="door-btn">加载中...</button>
        </div>
        
        <div class="device-info">
          <h3>设备状态</h3>
          <p class="result" id="lock1-status">门1状态: 查询中...</p>
          <p class="result" id="lock1-update-time">最后更新时间: 查询中...</p>
          <p class="result" id="lock2-status">门2状态: 查询中...</p>
          <p class="result" id="lock2-update-time">最后更新时间: 查询中...</p>
          <p class="result" id="lock3-status">门3状态: 查询中...</p>
          <p class="result" id="lock3-update-time">最后更新时间: 查询中...</p>
        </div>
      </div>

      <!-- 异常处理界面 -->
      <div id="teacher-exception" class="tab-panel">
        <h2>归还超时记录</h2>
        <div class="search-container">
          <input type="text" id="exception-search" placeholder="搜索..." class="search-input">
        </div>
        <!-- 添加错误标志显示区域 -->
        <div class="status-display">
          <div class="status-title">
            <span></span>
            <button id="toggle-monitor-data" class="status-toggle">
              <span id="toggle-text"></span>
            </button>
          </div>
          <div id="monitor-data-content" class="status-items" style="display: none;">
            <div class="status-item">
              <span class="status-label">错误标志(error_flag):</span>
              <span id="current-error-flag" class="status-value" style="color: var(--primary-color); background: var(--primary-light);">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">柜子号(cabinet):</span>
              <span id="current-cabinet" class="status-value" style="color: var(--success-color); background: var(--success-light);">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">器材类型(equipment_type):</span>
              <span id="current-equipment-type" class="status-value" style="color: var(--danger-color); background: var(--danger-light);">乒乓球</span>
            </div>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>账号</th>
              <th>姓名</th>
              <th>时期</th>
              <th>柜子</th>
              <th>器材</th>
              <th>状态</th>
            </tr>
          </thead>
          <tbody id="exception-table-body">
            <tr>
              <td>201801</td><td>张明</td><td></td><td>2</td><td>乒乓球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201802</td><td>李华</td><td></td><td>1</td><td>跳绳</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201803</td><td>王芳</td><td></td><td>3</td><td>篮球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201804</td><td>赵强</td><td></td><td>2</td><td>乒乓球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201805</td><td>陈静</td><td></td><td>1</td><td>篮球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201806</td><td>杨光</td><td></td><td>3</td><td>跳绳</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201807</td><td>周敏</td><td></td><td>2</td><td>篮球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
            <tr>
              <td>201808</td><td>吴强</td><td></td><td>1</td><td>乒乓球</td><td class="status-cell" data-status="done">已处理</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 教师二维码界面 -->
      <div id="teacher-qrcode" class="tab-panel">
        <h2>教师二维码</h2>
        <div class="qrcode-container">
          <p class="qrcode-title">教师识别二维码</p>
          <div class="qrcode-image-container">
            <img id="teacher-qrcode-image" alt="教师二维码" class="qrcode-image">
          </div>
          <p class="qrcode-hint">请在设备前出示此二维码</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化暗黑模式
      initDarkMode();

      // 设置默认账号密码
      document.getElementById('student-username').value = '210797';
      document.getElementById('student-password').value = '210797';
      document.getElementById('teacher-username').value = '359921';
      document.getElementById('teacher-password').value = '359921';
      
      // 设备状态变量
      let deviceVariables = {
        use_flag: false,
        equipment_type: 0,
        use_time: 0,
        错误标志: 0,
        cabinet: 0,
        Lock1: false,
        Lock2: false,
        Lock3: false
      };
      
      // 保存上一个状态的use_flag，用于检测变化
      let previousUseFlag = false;
      
      // 初始化历史记录
      generateInitialHistoryRecords();
      
      // 按钮点击波纹效果
      addRippleEffect();
      
      // 为门按钮添加样式
      setupDoorButtons();
      
      // 暗黑模式切换
      function initDarkMode() {
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        // 检查本地存储或系统偏好
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
        }
        
        // 点击切换主题
        themeToggle.addEventListener('click', function() {
          document.body.classList.toggle('dark-mode');
          
          if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            themeIcon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
          } else {
            localStorage.setItem('theme', 'light');
            themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
          }
          
          // 添加切换动画
          themeToggle.classList.add('theme-transition');
          setTimeout(() => {
            themeToggle.classList.remove('theme-transition');
          }, 300);
        });
      }
      
      // 生成初始的历史记录数据
      function generateInitialHistoryRecords() {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return;
        
        // 清空现有记录
        historyTableBody.innerHTML = '';
        
        // 获取当前日期
        const today = new Date();
        
        // 器材类型选项
        const equipmentTypes = ['乒乓球', '跳绳', '篮球'];
        
        // 生成20条历史记录，均匀分布在过去两个月内
        for (let i = 0; i < 20; i++) {
          // 计算日期，均匀分布在过去两个月内
          const daysAgo = Math.floor((60 / 20) * (i + 1));
          const recordDate = new Date(today);
          recordDate.setDate(today.getDate() - daysAgo);
          
          // 格式化日期
          const dateStr = recordDate.getFullYear() + '-' + 
                         String(recordDate.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(recordDate.getDate()).padStart(2, '0');
          
          // 随机选择器材
          const equipment = equipmentTypes[Math.floor(Math.random() * equipmentTypes.length)];
          
          // 随机生成0.5到3小时的使用时长
          const usageTime = (Math.random() * 2.5 + 0.5).toFixed(1);
          
          // 创建表格行
          const row = document.createElement('tr');
          row.innerHTML = `<td>${dateStr}</td><td>${equipment}</td><td>${usageTime}</td>`;
          
          // 添加到表格
          historyTableBody.appendChild(row);
        }
        
        // 更新总使用时长
        updateTotalHours();
      }
      
      // 添加按钮点击波纹效果
      function addRippleEffect() {
        document.querySelectorAll('button').forEach(button => {
          button.addEventListener('click', function(e) {
            const rect = button.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const ripple = document.createElement('span');
            ripple.classList.add('ripple-effect');
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            
            button.appendChild(ripple);
            
            setTimeout(() => {
              ripple.remove();
            }, 600);
          });
        });
      }
      
      // 设置门按钮样式
      function setupDoorButtons() {
        const doorButtons = document.querySelectorAll('.door-btn');
        doorButtons.forEach(btn => {
          btn.style.width = '120px';
          if (btn.id !== 'door3-toggle') {
            btn.style.marginRight = '10px';
          }
        });
      }
      
      // 存储用户名和姓名的映射
      const userNameMap = {
        '175905': '李明',
        '210797': '张华',
        '175908': '王芳'
      };
      
      // OneNet物联网平台API配置
      const config = {
        productId: '56i5KnK1KX',
        deviceName: 'ch32',
        authorization: 'version=2018-10-31&res=products%2F56i5KnK1KX%2Fdevices%2Fch32&et=1767233340&method=md5&sign=xTIiV6aZQvvpq1yJti58tQ%3D%3D',
        queryApiUrl: 'https://iot-api.heclouds.com/thingmodel/query-device-property',
        setApiUrl: 'https://iot-api.heclouds.com/thingmodel/set-device-desired-property'
      };
      
      // 辅助函数
      function convertToBoolean(value) {
        if (typeof value === 'boolean') return value;
        if (value === 'true' || value === '1' || value === 1) return true;
        if (value === 'false' || value === '0' || value === 0) return false;
        return Boolean(value);
      }
      
      function getCurrentDateString() {
        const today = new Date();
        return today.getFullYear() + '-' + 
               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
               String(today.getDate()).padStart(2, '0');
      }
      
      function formatDate(year, month, day) {
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      }
      
      // 生成最近两个月内的随机日期
      function generateRecentDate(daysAgo) {
        const today = new Date();
        const pastDate = new Date(today);
        pastDate.setDate(today.getDate() - daysAgo);
        
        const year = pastDate.getFullYear();
        const month = String(pastDate.getMonth() + 1).padStart(2, '0');
        const day = String(pastDate.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
      }
      
      // 更新表格中的日期为最近两个月内的日期
      const dateCells = document.querySelectorAll('#exception-table-body tr td:nth-child(3)');
      dateCells.forEach((cell, index) => {
        // 根据索引生成不同的日期，确保日期分布在最近两个月内
        const daysAgo = 5 + (index * 7); // 5, 12, 19, 26, 33, 40, 47, 54天前
        cell.textContent = generateRecentDate(daysAgo);
      });
      
      // 绑定状态单元格点击事件
      document.querySelectorAll('.status-cell').forEach(cell => {
        cell.addEventListener('click', function() {
          const currentStatus = this.getAttribute('data-status');
          const newStatus = currentStatus === 'done' ? 'pending' : 'done';
          
          // 更新状态文本和属性
          this.setAttribute('data-status', newStatus);
          this.textContent = newStatus === 'done' ? '已处理' : '未处理';
          
          // 确保颜色样式正确应用
          if (newStatus === 'pending') {
            this.style.color = '#dc3545';
            this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
          } else {
            this.style.color = '#28a745';
            this.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
          }
        });
      });
      
      // 添加实时监控数据的显示/隐藏功能
      const toggleMonitorBtn = document.getElementById('toggle-monitor-data');
      if (toggleMonitorBtn) {
        // 移除箭头图标
        const svgElement = toggleMonitorBtn.querySelector('svg');
        if (svgElement) {
          svgElement.remove();
        }
        
        toggleMonitorBtn.addEventListener('click', function() {
          const contentDiv = document.getElementById('monitor-data-content');
          const toggleText = document.getElementById('toggle-text');
          
          if (contentDiv.style.display === 'none') {
            contentDiv.style.display = 'flex';
            toggleText.textContent = '';
          } else {
            contentDiv.style.display = 'none';
            toggleText.textContent = '';
          }
        });
      }
      
      // 界面切换事件
      document.querySelectorAll('.menu-btn').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const dashboard = this.closest('.card');
          
          dashboard.querySelectorAll('.tab-panel').forEach(panel => {
            panel.style.display = 'none';
          });
          
          if(targetId) {
            document.getElementById(targetId).style.display = 'block';
            
            if(targetId === 'teacher-door') {
              queryDeviceStatus();
            } else if(targetId === 'student-qrcode') {
              loadStudentQRCode();
            } else if(targetId === 'teacher-qrcode') {
              loadTeacherQRCode();
            } else if(targetId === 'teacher-exception') {
              setTimeout(() => {
                fetchDeviceVariables();
              }, 100);
            } else if(targetId === 'student-history') {
              document.getElementById('student-history').style.display = 'block';
              fetchDeviceVariables();
            }
          }
        });
      });
      
      // 设备状态查询
      const deviceStatusInterval = setInterval(fetchDeviceVariables, 1000);
      fetchDeviceVariables();
      
      // 从OneNet API获取设备变量
      async function fetchDeviceVariables() {
        try {
          const apiUrl = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          // 更新调试信息区域
          const debugInfo = document.getElementById('debug-info');
          if (debugInfo) {
            debugInfo.textContent = JSON.stringify(data, null, 2);
          }
          
          if (data.code === 0 && data.data) {
            let properties = [];
            let rawPropertiesData = '无属性数据';
            
            if (data.data && data.data.list) {
              properties = data.data.list;
              rawPropertiesData = JSON.stringify(data.data.list, null, 2);
            } else if (Array.isArray(data.data)) {
              properties = data.data;
              rawPropertiesData = JSON.stringify(data.data, null, 2);
            }
            
            console.log('API返回的原始数据:', data);
            console.log('解析的属性列表:', properties);
            
            // 保存之前的use_flag状态
            const oldUseFlag = deviceVariables.use_flag;
            const oldErrorFlag = deviceVariables.错误标志;
            
            const useFlagProperty = properties.find(prop => prop.identifier === 'use_flag');
            const equipmentTypeProperty = properties.find(prop => prop.identifier === 'equipment_type');
            const useTimeProperty = properties.find(prop => prop.identifier === 'use_time');
            const errorFlagProperty = properties.find(prop => prop.identifier === '错误标志');
            const cabinetProperty = properties.find(prop => prop.identifier === 'cabinet');
            const lock1Property = properties.find(prop => prop.identifier === 'Lock1');
            const lock2Property = properties.find(prop => prop.identifier === 'Lock2');
            const lock3Property = properties.find(prop => prop.identifier === 'Lock3');
            
            // 检查错误标志属性是否存在
            if (!errorFlagProperty) {
              console.warn('警告: 未找到标识符为"错误标志"的属性，正在尝试查找替代属性...');
              
              // 在调试信息中添加属性标识符列表
              if (debugInfo) {
                debugInfo.textContent = 
                  '所有属性标识符: ' + 
                  properties.map(p => p.identifier).join(', ') + 
                  '\n\n原始数据:\n' + rawPropertiesData;
              }
            }
            
            // 更新设备变量状态
            if (useFlagProperty) {
              deviceVariables.use_flag = convertToBoolean(useFlagProperty.value);
              
              // 更新使用状态显示
              const useFlagDisplay = document.getElementById('current-use-flag');
              if (useFlagDisplay) {
                useFlagDisplay.textContent = deviceVariables.use_flag.toString();
                // 改变颜色来突显状态
                if (deviceVariables.use_flag) {
                  useFlagDisplay.style.color = '#28a745';
                  useFlagDisplay.style.backgroundColor = '#e5f9ee';
                } else {
                  useFlagDisplay.style.color = '#007bff';
                  useFlagDisplay.style.backgroundColor = '#e9f5ff';
                }
              }
            }
            
            if (equipmentTypeProperty) {
              deviceVariables.equipment_type = parseInt(equipmentTypeProperty.value) || 0;
              
              // 更新器材类型显示
              const equipmentTypeDisplay = document.getElementById('current-student-equipment-type');
              if (equipmentTypeDisplay) {
                let equipmentName = '乒乓球';
                if (deviceVariables.equipment_type === 1) {
                  equipmentName = '跳绳';
                } else if (deviceVariables.equipment_type === 2) {
                  equipmentName = '篮球';
                } else if (deviceVariables.equipment_type !== 0) {
                  equipmentName = '未选择';
                }
                equipmentTypeDisplay.textContent = equipmentName;
              }
              
              const equipmentTypeDisplay2 = document.getElementById('current-equipment-type');
              if (equipmentTypeDisplay2) {
                let equipmentName = '乒乓球';
                if (deviceVariables.equipment_type === 1) {
                  equipmentName = '跳绳';
                } else if (deviceVariables.equipment_type === 2) {
                  equipmentName = '篮球';
                } else if (deviceVariables.equipment_type !== 0) {
                  equipmentName = '未选择';
                }
                equipmentTypeDisplay2.textContent = equipmentName;
              }
            }
            
            if (useTimeProperty) {
              deviceVariables.use_time = parseFloat(useTimeProperty.value) || 0;
              
              // 更新使用时长显示
              const useTimeDisplay = document.getElementById('current-use-time');
              if (useTimeDisplay) {
                useTimeDisplay.textContent = deviceVariables.use_time.toString();
              }
            }
            
            if (errorFlagProperty) {
              deviceVariables.错误标志 = parseInt(errorFlagProperty.value) || 0;
              
              // 更新错误标志显示
              const errorFlagDisplay = document.getElementById('current-error-flag');
              if (errorFlagDisplay) {
                errorFlagDisplay.textContent = deviceVariables.错误标志;
              }
              
              // 添加调试日志
              console.log('错误标志属性:', errorFlagProperty);
              console.log('错误标志值:', errorFlagProperty.value, '转换后:', deviceVariables.错误标志);
            } else {
              // 尝试使用其他可能的标识符查找错误标志
              let foundErrorProperty = null;
              const possibleIdentifiers = ['错误标记', 'error_flag', 'errorFlag', 'error', 'flag', 'ErrorFlag', 'ErrorCode'];
              
              for (const identifier of possibleIdentifiers) {
                const prop = properties.find(p => p.identifier === identifier);
                if (prop) {
                  foundErrorProperty = prop;
                  console.log(`找到可能的错误标志属性: ${identifier}`, prop);
                  break;
                }
              }
              
              // 尝试直接查找是否有属性的值匹配我们期望的error_flag值
              const targetAccountNumbers = [175905, 210797, 175908];
              if (!foundErrorProperty) {
                for (const prop of properties) {
                  const numValue = typeof prop.value === 'number' ? prop.value : 
                                  parseInt(String(prop.value).trim());
                  
                  if (!isNaN(numValue) && targetAccountNumbers.includes(numValue)) {
                    console.log(`找到值匹配的属性! 属性: ${prop.identifier}, 值: ${numValue}`);
                    foundErrorProperty = prop;
                    break;
                  }
                }
              }
              
              // 如果上述标识符都不匹配，尝试模糊匹配
              if (!foundErrorProperty) {
                foundErrorProperty = properties.find(p => 
                  p.identifier.includes('error') || 
                  p.identifier.includes('flag') || 
                  p.identifier.includes('错误') ||
                  (typeof p.value === 'number' && p.value > 100000)  // 假设错误标志是大于10万的数字
                );
                
                if (foundErrorProperty) {
                  console.log('通过模糊匹配找到可能的错误标志:', foundErrorProperty);
                }
              }
              
              // 调试输出所有属性
              console.log('所有设备属性:');
              properties.forEach(prop => {
                console.log(`${prop.identifier}: ${prop.value} (类型: ${typeof prop.value})`);
              });
              
              if (foundErrorProperty) {
                // 尝试不同的方式解析错误标志值
                let errorValue = 0;
                if (typeof foundErrorProperty.value === 'string') {
                  errorValue = parseInt(foundErrorProperty.value) || 0;
                } else if (typeof foundErrorProperty.value === 'number') {
                  errorValue = foundErrorProperty.value;
                } else {
                  errorValue = Number(foundErrorProperty.value) || 0;
                }
                
                deviceVariables.错误标志 = errorValue;
                console.log(`解析到错误标志值: ${errorValue}`);
                
                // 更新错误标志显示
                const errorFlagDisplay = document.getElementById('current-error-flag');
                if (errorFlagDisplay) {
                  errorFlagDisplay.textContent = deviceVariables.错误标志;
                }
              } else {
                console.warn('未找到合适的错误标志属性');
                
                // 在调试信息中显示所有属性
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                  debugInfo.textContent += '\n\n未找到错误标志属性，所有可用属性:\n' + 
                    properties.map(p => `${p.identifier}: ${p.value} (${typeof p.value})`).join('\n');
                }
              }
            }
            
            if (cabinetProperty) {
              deviceVariables.cabinet = parseInt(cabinetProperty.value) || 0;
              
              // 更新柜子号显示
              const cabinetDisplay = document.getElementById('current-cabinet');
              if (cabinetDisplay) {
                cabinetDisplay.textContent = deviceVariables.cabinet;
              }
            }
            
            if (lock1Property) {
              deviceVariables.Lock1 = convertToBoolean(lock1Property.value);
              updateLockDisplay(1, deviceVariables.Lock1);
            }
            
            if (lock2Property) {
              deviceVariables.Lock2 = convertToBoolean(lock2Property.value);
              updateLockDisplay(2, deviceVariables.Lock2);
            }
            
            if (lock3Property) {
              deviceVariables.Lock3 = convertToBoolean(lock3Property.value);
              updateLockDisplay(3, deviceVariables.Lock3);
            }
            
            // 检查错误标志变化并添加记录
            if (oldErrorFlag !== deviceVariables.错误标志 && deviceVariables.错误标志 !== 0) {
              const errorId = deviceVariables.错误标志.toString();
              // 只处理特定的错误ID
              if (errorId === '210797' || errorId === '175905' || errorId === '175908') {
                addExceptionRecord(errorId);
              }
            }
            
            // 检查use_flag的变化并更新历史记录
            const currentDateStr = getCurrentDateString();
            const historyTableBody = document.getElementById('history-table-body');
            
            if (historyTableBody) {
              // 当use_flag从false变为true时添加或更新记录
              if (oldUseFlag === false && deviceVariables.use_flag === true) {
                console.log('检测到使用状态变化: false -> true，更新历史记录');
                const existingTodayRow = findTodayRow(historyTableBody, currentDateStr);
                
                if (existingTodayRow) {
                  // 如果今天已有记录，则更新该记录
                  updateHistoryRow(existingTodayRow, true);
                } else {
                  // 否则创建新记录
                  insertNewHistoryRecord(currentDateStr, true);
                }
              }
              // 当use_flag从true变为false时替换"进行中"为实际使用时长
              else if (oldUseFlag === true && deviceVariables.use_flag === false) {
                console.log('检测到使用状态变化: true -> false，更新使用时长');
                const existingTodayRow = findTodayRow(historyTableBody, currentDateStr);
                
                if (existingTodayRow) {
                  // 更新使用时长
                  updateHistoryRow(existingTodayRow, false);
                }
              }
            }
            
            // 保存当前状态用于下次比较
            previousUseFlag = deviceVariables.use_flag;
            
            return true;
          } else {
            console.error('设备状态查询失败:', data.msg || '未知错误');
            return false;
          }
        } catch (error) {
          console.error('获取设备状态失败:', error);
          document.getElementById('lock1-status').textContent = '门1状态: 查询出错';
          document.getElementById('lock2-status').textContent = '门2状态: 查询出错';
          document.getElementById('lock3-status').textContent = '门3状态: 查询出错';
          return false;
        }
      }
      
      // 添加异常记录函数
      function addExceptionRecord(errorId) {
        const exceptionTableBody = document.getElementById('exception-table-body');
        if (!exceptionTableBody) return;
        
        // 获取用户信息
        const userName = userNameMap[errorId] || '未知用户';
        
        // 获取当前日期
        const today = getCurrentDateString();
        
        // 获取柜子编号
        const cabinetNumber = deviceVariables.cabinet || 1;
        
        // 获取器材类型
        let equipmentName = '乒乓球';
        if (deviceVariables.equipment_type === 1) {
          equipmentName = '跳绳';
        } else if (deviceVariables.equipment_type === 2) {
          equipmentName = '篮球';
        }
        
        // 创建新的表格行
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${errorId}</td>
          <td>${userName}</td>
          <td>${today}</td>
          <td>${cabinetNumber}</td>
          <td>${equipmentName}</td>
          <td class="status-cell" data-status="pending">未处理</td>
        `;
        
        // 添加到表格顶部
        if (exceptionTableBody.firstChild) {
          exceptionTableBody.insertBefore(newRow, exceptionTableBody.firstChild);
        } else {
          exceptionTableBody.appendChild(newRow);
        }
        
        // 绑定状态单元格点击事件
        const statusCell = newRow.querySelector('.status-cell');
        if (statusCell) {
          statusCell.addEventListener('click', function() {
            const currentStatus = this.getAttribute('data-status');
            const newStatus = currentStatus === 'done' ? 'pending' : 'done';
            
            // 更新状态文本和属性
            this.setAttribute('data-status', newStatus);
            this.textContent = newStatus === 'done' ? '已处理' : '未处理';
            
            // 确保颜色样式正确应用
            if (newStatus === 'pending') {
              this.style.color = '#dc3545';
              this.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
            } else {
              this.style.color = '#28a745';
              this.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
            }
          });
        }
      }
      
      // 历史记录相关函数
      function findTodayRow(tableBody, dateStr) {
        for (let i = 0; i < tableBody.rows.length; i++) {
          const row = tableBody.rows[i];
          const dateCell = row.cells[0];
          if (dateCell && dateCell.textContent === dateStr) {
            return row;
          }
        }
        return null;
      }
      
      function updateHistoryRow(row, inProgress) {
        if (!row) return;
        
        const equipmentCell = row.cells[1];
        const durationCell = row.cells[2];
        
        // 获取当前设备使用的器材名称
        let currentEquipment = '乒乓球';
        if (deviceVariables.equipment_type === 1) {
          currentEquipment = '跳绳';
        } else if (deviceVariables.equipment_type === 2) {
          currentEquipment = '篮球';
        } else if (deviceVariables.equipment_type !== 0) {
          currentEquipment = '未选择';
        }
        
        // 更新器材显示：如果不同则添加新器材，用逗号分隔
        if (!equipmentCell.textContent.includes(currentEquipment)) {
          if (equipmentCell.textContent.trim() !== '') {
            equipmentCell.textContent = equipmentCell.textContent + ', ' + currentEquipment;
          } else {
            equipmentCell.textContent = currentEquipment;
          }
        }
        
        // 更新使用时长
        if (inProgress) {
          // 如果是开始使用，显示"进行中"
          durationCell.textContent = '进行中';
          durationCell.style.color = '#007bff'; // 蓝色
          durationCell.style.fontWeight = 'bold';
        } else {
          // 如果是结束使用，显示实际使用时长
          durationCell.textContent = deviceVariables.use_time.toFixed(1);
          durationCell.style.color = ''; // 恢复默认颜色
          durationCell.style.fontWeight = '';
        }
        
        // 更新总时长统计
        updateTotalHours();
      }
      
      function insertNewHistoryRecord(dateStr, inProgress) {
        const historyTableBody = document.getElementById('history-table-body');
        if (!historyTableBody) return null;
        
        if (!dateStr) dateStr = getCurrentDateString();
        
        // 检查是否已存在当天的记录
        const existingRow = findTodayRow(historyTableBody, dateStr);
        if (existingRow) {
          updateHistoryRow(existingRow, inProgress);
          return existingRow;
        }
        
        // 获取当前器材名称
        let equipment = '乒乓球';
        if (deviceVariables.equipment_type === 1) {
          equipment = '跳绳';
        } else if (deviceVariables.equipment_type === 2) {
          equipment = '篮球';
        } else if (deviceVariables.equipment_type !== 0) {
          equipment = '未选择';
        }
        
        // 显示的使用时长
        let displayTime = inProgress ? '进行中' : deviceVariables.use_time.toFixed(1);
        
        // 创建新记录行
        const newRow = document.createElement('tr');
        newRow.innerHTML = `<td>${dateStr}</td><td>${equipment}</td><td style="${inProgress ? 'color: #007bff; font-weight: bold;' : ''}">${displayTime}</td>`;
        
        // 插入到表格顶部
        if (historyTableBody.firstChild) {
          historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
        } else {
          historyTableBody.appendChild(newRow);
        }
        
        // 更新总时长统计
        updateTotalHours();
        return newRow;
      }
      
      function updateTotalHours() {
        const totalHoursElement = document.getElementById('total-year-hours');
        if (!totalHoursElement) return;
        
        const hours = Array.from(document.querySelectorAll('#student-history tbody td:nth-child(3)'))
          .map(td => td.textContent === '进行中' ? 0 : (parseFloat(td.textContent) || 0));
        
        const totalHours = hours.reduce((sum, hour) => sum + hour, 0);
        totalHoursElement.textContent = totalHours.toFixed(1);
      }
      
      // 登录切换和验证
      document.getElementById('student-tab').addEventListener('click', () => toggleLoginPanels('student'));
      document.getElementById('teacher-tab').addEventListener('click', () => toggleLoginPanels('teacher'));
      
      function toggleLoginPanels(userType) {
        const isStudent = userType === 'student';
        
        // 添加动画
        const oldPanel = isStudent ? document.getElementById('teacher-login') : document.getElementById('student-login');
        const newPanel = isStudent ? document.getElementById('student-login') : document.getElementById('teacher-login');
        
        oldPanel.style.animation = 'fadeOut 0.3s ease forwards';
        
        setTimeout(() => {
          document.getElementById('student-login').classList.toggle('hidden', !isStudent);
          document.getElementById('teacher-login').classList.toggle('hidden', isStudent);
          document.getElementById('student-tab').classList.toggle('active', isStudent);
          document.getElementById('teacher-tab').classList.toggle('active', !isStudent);
          
          newPanel.style.animation = 'fadeIn 0.3s ease';
        }, 300);
      }
      
      let currentLogin = {
        student: { username: '210797', password: '210797' },
        teacher: { username: '359921', password: '359921' }
      };
      
      document.getElementById('student-login-btn').addEventListener('click', (e) => {
        addLoginButtonEffect(e.currentTarget);
        setTimeout(() => login('student'), 300);
      });
      
      document.getElementById('teacher-login-btn').addEventListener('click', (e) => {
        addLoginButtonEffect(e.currentTarget);
        setTimeout(() => login('teacher'), 300);
      });
      
      function addLoginButtonEffect(button) {
        button.classList.add('login-btn-clicked');
        setTimeout(() => {
          button.classList.remove('login-btn-clicked');
        }, 300);
      }
      
      function login(userType) {
        const username = document.getElementById(userType + '-username').value;
        const password = document.getElementById(userType + '-password').value;
        
        const credentials = {
          student: {username: '210797', password: '210797'},
          teacher: {username: '359921', password: '359921'},
          '175905': {type: 'student', password: '175905'},
          '175908': {type: 'student', password: '175908'}
        };
        
        let loginSuccess = false;
        let dashboardType = '';
        
        if (userType === 'student' && username === credentials.student.username && 
            password === credentials.student.password) {
          loginSuccess = true;
          dashboardType = 'student';
          currentLogin.student = { username, password };
        } 
        else if (userType === 'teacher' && username === credentials.teacher.username && 
            password === credentials.teacher.password) {
          loginSuccess = true;
          dashboardType = 'teacher';
          currentLogin.teacher = { username, password };
        } 
        else if (credentials[username] && credentials[username].type === 'student' && 
            credentials[username].password === password) {
          loginSuccess = true;
          dashboardType = 'student';
          currentLogin.student = { username, password };
        }
        
        if (loginSuccess) {
          document.getElementById('login-section').classList.add('hidden');
          document.getElementById(dashboardType + '-dashboard').classList.remove('hidden');
          
          const firstMenuBtn = document.querySelector('#' + dashboardType + '-dashboard .menu-btn');
          if (firstMenuBtn) firstMenuBtn.click();
        } else {
          alert(userType === 'student' ? '学生账号或密码错误!' : '教师账号或密码错误!');
        }
      }

      document.getElementById('student-logout').addEventListener('click', () => logout('student'));
      document.getElementById('teacher-logout').addEventListener('click', () => logout('teacher'));
      
      function logout(userType) {
        document.getElementById(userType + '-dashboard').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        
        if (userType === 'student') {
          document.getElementById('student-tab').click();
          document.getElementById('student-username').value = currentLogin.student.username;
          document.getElementById('student-password').value = currentLogin.student.password;
        } else {
          document.getElementById('teacher-tab').click();
          document.getElementById('teacher-username').value = currentLogin.teacher.username;
          document.getElementById('teacher-password').value = currentLogin.teacher.password;
        }
      }

      // 设备状态和控制
      let deviceStatus = {
        isLocked1: true,
        isLocked2: true,
        isLocked3: true,
        lastUpdateTime1: '',
        lastUpdateTime2: '',
        lastUpdateTime3: ''
      };
      
      async function queryDeviceStatus() {
        try {
          const url = `${config.queryApiUrl}?product_id=${encodeURIComponent(config.productId)}&device_name=${encodeURIComponent(config.deviceName)}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': config.authorization
            }
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.code === 0 && data.data) {
            let properties = [];
            
            if (data.data && data.data.list) {
              properties = data.data.list;
            } else if (Array.isArray(data.data)) {
              properties = data.data;
            }
            
            const currentTime = new Date().toLocaleString();
            
            const lock1Property = properties.find(prop => prop.identifier === 'Lock1');
            const lock2Property = properties.find(prop => prop.identifier === 'Lock2');
            const lock3Property = properties.find(prop => prop.identifier === 'Lock3');
            
            if (lock1Property) {
              deviceStatus.isLocked1 = convertToBoolean(lock1Property.value);
              deviceStatus.lastUpdateTime1 = currentTime;
              updateLockDisplay(1, deviceStatus.isLocked1, deviceStatus.lastUpdateTime1);
            }
            
            if (lock2Property) {
              deviceStatus.isLocked2 = convertToBoolean(lock2Property.value);
              deviceStatus.lastUpdateTime2 = currentTime;
              updateLockDisplay(2, deviceStatus.isLocked2, deviceStatus.lastUpdateTime2);
            }
            
            if (lock3Property) {
              deviceStatus.isLocked3 = convertToBoolean(lock3Property.value);
              deviceStatus.lastUpdateTime3 = currentTime;
              updateLockDisplay(3, deviceStatus.isLocked3, deviceStatus.lastUpdateTime3);
            }
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '查询失败');
          }
        } catch (error) {
          console.error('查询设备状态失败:', error);
          document.getElementById('lock1-status').textContent = '门1状态: 查询出错';
          document.getElementById('lock2-status').textContent = '门2状态: 查询出错';
          document.getElementById('lock3-status').textContent = '门3状态: 查询出错';
          return false;
        }
      }
      
      async function setDeviceLockStatus(lockNumber, isLocked) {
        try {
          const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
          if (doorToggleBtn) doorToggleBtn.disabled = true;
          
          const requestData = {
            product_id: config.productId,
            device_name: config.deviceName,
            params: { [`Lock${lockNumber}`]: isLocked }
          };
          
          const response = await fetch(config.setApiUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'Authorization': config.authorization
            },
            body: JSON.stringify(requestData)
          });
          
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.errno === 0 || data.code === 0) {
            deviceStatus[`isLocked${lockNumber}`] = isLocked;
            const currentTime = new Date().toLocaleString();
            deviceStatus[`lastUpdateTime${lockNumber}`] = currentTime;
            
            updateLockDisplay(lockNumber, isLocked, currentTime);
            
            setTimeout(() => queryDeviceStatus(), 2000);
            
            return true;
          } else {
            throw new Error(data.error || data.msg || '设置失败');
          }
        } catch (error) {
          console.error(`设置门锁${lockNumber}状态失败:`, error);
          document.getElementById(`lock${lockNumber}-status`).textContent = `门${lockNumber}状态: 设置失败`;
          return false;
        } finally {
          const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
          if (doorToggleBtn) doorToggleBtn.disabled = false;
        }
      }
      
      document.getElementById('door1-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock1 || deviceStatus.isLocked1;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(1, newLockStatus);
      });
      
      document.getElementById('door2-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock2 || deviceStatus.isLocked2;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(2, newLockStatus);
      });
      
      document.getElementById('door3-toggle').addEventListener('click', async () => {
        const currentLockStatus = deviceVariables.Lock3 || deviceStatus.isLocked3;
        const newLockStatus = !currentLockStatus;
        await setDeviceLockStatus(3, newLockStatus);
      });
      
      // 二维码加载
      function loadStudentQRCode() {
        const studentUsername = document.getElementById('student-username').value || '210797';
        document.getElementById('qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${studentUsername}`;
      }

      function loadTeacherQRCode() {
        const teacherUsername = document.getElementById('teacher-username').value || '359921';
        document.getElementById('teacher-qrcode-image').src = 
          `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${teacherUsername}`;
      }

      // 更新门锁状态显示
      function updateLockDisplay(lockNumber, isLocked, updateTime) {
        const lockStatusElement = document.getElementById(`lock${lockNumber}-status`);
        if (lockStatusElement) {
          lockStatusElement.textContent = `门${lockNumber}状态: ${isLocked ? '已关门' : '已开门'}`;
        }
        
        const updateTimeElement = document.getElementById(`lock${lockNumber}-update-time`);
        if (updateTimeElement && updateTime) {
          updateTimeElement.textContent = `最后更新时间: ${updateTime}`;
        }
        
        const doorToggleBtn = document.getElementById(`door${lockNumber}-toggle`);
        if (doorToggleBtn) {
          doorToggleBtn.textContent = isLocked ? '已关门' : '已开门';
          doorToggleBtn.classList.remove('door-open', 'door-closed');
          doorToggleBtn.classList.add(isLocked ? 'door-closed' : 'door-open');
        }
        
        deviceStatus[`isLocked${lockNumber}`] = isLocked;
      }

      // 添加样式和交互
      const styleElement = document.createElement('style');
      styleElement.textContent = `
        .ripple-effect {
          position: absolute;
          border-radius: 50%;
          background-color: rgba(255, 255, 255, 0.5);
          width: 100px;
          height: 100px;
          margin-top: -50px;
          margin-left: -50px;
          animation: ripple-animation 0.6s ease-out;
          pointer-events: none;
        }
        
        @keyframes ripple-animation {
          0% {
            transform: scale(0);
            opacity: 0.5;
          }
          100% {
            transform: scale(2);
            opacity: 0;
          }
        }
        
        .theme-transition {
          animation: theme-rotate 0.3s ease;
        }
        
        @keyframes theme-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
        
        .login-btn-clicked {
          transform: scale(0.95);
          opacity: 0.9;
        }
        
        .menu-btn {
          position: relative;
          overflow: hidden;
          transition: all 0.3s ease;
        }
        
        .menu-btn:hover {
          transform: translateY(-3px);
          box-shadow: 0 6px 12px rgba(0, 123, 255, 0.3);
        }
        
        .total-hours {
          font-size: 18px;
          font-weight: 500;
          color: var(--primary-color);
          margin: 15px 0;
          padding: 10px;
          border-radius: 8px;
          background-color: var(--primary-light);
          display: inline-block;
        }
        
        #qrcode-image, #teacher-qrcode-image {
          transition: transform 0.3s ease;
        }
        
        #qrcode-image:hover, #teacher-qrcode-image:hover {
          transform: scale(1.05);
        }
        
        .login-panel input:focus + label,
        .login-panel input:valid + label {
          transform: translateY(-25px);
          font-size: 14px;
          color: var(--primary-color);
        }
      `;
      document.head.appendChild(styleElement);
    });
  </script>
</body>
</html>